<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA ‚Äî The Social Cosmos</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Outfit:wght@200;400;600&family=JetBrains+Mono:wght@400&display=swap');
        :root{--gold:#e8c547;--gold-dim:#a68a2a;--pink:#ff6b9d;--blue:#4ecdc4;--purple:#a855f7;--void:#030306;--glass:rgba(255,255,255,0.05);--glass-hover:rgba(255,255,255,0.1);--glass-border:rgba(255,255,255,0.1);--text-primary:rgba(255,255,255,0.95);--text-secondary:rgba(255,255,255,0.65);--text-dim:rgba(255,255,255,0.35);--red:#ef4444;--green:#22c55e;--orange:#f97316}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{width:100%;height:100%;overflow:hidden;background:var(--void);font-family:'Outfit',sans-serif;color:white;touch-action:none;user-select:none}
        @media(hover:hover){body{cursor:none}#cursor{display:block}}
        canvas{display:block;position:absolute;top:0;left:0}
        #cursor{position:fixed;width:30px;height:30px;pointer-events:none;z-index:10000;display:none}
        #cursor::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;background:var(--gold);border-radius:50%;box-shadow:0 0 20px var(--gold)}
        #cursor::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:26px;height:26px;border:1px solid rgba(232,197,71,0.4);border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.5}50%{transform:translate(-50%,-50%) scale(1.15);opacity:0.2}}
        #ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}
        #top{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:12px 16px;gap:8px}
        #logo-area{display:flex;align-items:center;gap:10px;flex-shrink:0}
        #logo{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:300;letter-spacing:0.6em;color:var(--gold);text-shadow:0 0 40px rgba(232,197,71,0.4);animation:glow 4s infinite}
        @keyframes glow{0%,100%{text-shadow:0 0 30px rgba(232,197,71,0.3)}50%{text-shadow:0 0 50px rgba(232,197,71,0.6)}}
        #realm-pill{display:flex;align-items:center;gap:6px;padding:5px 12px;background:var(--glass);border:1px solid var(--glass-border);border-radius:20px;font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-secondary);pointer-events:auto;cursor:pointer;transition:all 0.25s}
        #realm-pill:hover{background:var(--glass-hover);border-color:var(--gold-dim)}
        #streak-pill{display:none;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(249,115,22,0.15));border:1px solid rgba(239,68,68,0.3);border-radius:16px;font-size:0.55rem;color:var(--red)}
        #streak-pill .fire{animation:fireWiggle 0.5s infinite}
        @keyframes fireWiggle{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}
        #top-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
        #voice-panel{display:flex;align-items:center;gap:5px;padding:5px 10px;background:var(--glass);border:1px solid var(--glass-border);border-radius:24px;pointer-events:auto}
        .voice-btn{width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);color:var(--text-secondary);font-size:0.85rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
        .voice-btn:hover{background:rgba(255,255,255,0.1)}
        .voice-btn.active{background:rgba(34,197,94,0.2);border-color:var(--green);color:var(--green);animation:voiceActive 1.5s infinite}
        @keyframes voiceActive{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)}50%{box-shadow:0 0 0 8px rgba(34,197,94,0)}}
        .voice-btn.muted{background:rgba(239,68,68,0.15);border-color:var(--red);color:var(--red)}
        #voice-viz{display:flex;align-items:center;gap:2px;height:16px;min-width:30px}
        .vbar{width:3px;background:var(--blue);border-radius:2px;transition:height 0.05s}
        #voice-status{font-size:0.55rem;color:var(--text-dim);min-width:32px;text-align:center}
        #identity{display:flex;align-items:center;gap:10px;padding:6px 14px 6px 8px;background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:30px;pointer-events:auto;cursor:pointer;transition:all 0.3s}
        #identity:hover{background:var(--glass-hover);border-color:var(--gold-dim);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.3)}
        #my-orb{width:32px;height:32px;border-radius:50%;position:relative;flex-shrink:0;transition:all 0.3s}
        #my-orb::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:2px solid transparent;transition:all 0.3s}
        #my-orb.speaking::after{border-color:var(--green);animation:speakRing 1s infinite}
        @keyframes speakRing{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.1);opacity:1}}
        #my-orb .lvl{position:absolute;bottom:-2px;right:-2px;width:14px;height:14px;background:var(--gold);border-radius:50%;font-size:0.45rem;font-weight:600;color:var(--void);display:flex;align-items:center;justify-content:center;border:2px solid var(--void)}
        #my-info{text-align:left;min-width:0}
        #my-name{font-size:0.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px}
        #my-title{font-size:0.55rem;color:var(--gold);letter-spacing:0.1em;text-transform:uppercase}
        #stats{position:absolute;top:58px;right:16px;display:flex;flex-direction:column;gap:4px;min-width:150px}
        .stat{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--glass);border:1px solid var(--glass-border);border-radius:10px}
        .stat-icon{font-size:0.9rem;width:20px;text-align:center}
        .stat-content{flex:1;min-width:0}
        .stat-label{font-size:0.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em}
        .stat-val{font-size:0.75rem;font-weight:600}
        .stat-bar{height:3px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;margin-top:2px}
        .stat-fill{height:100%;border-radius:3px;transition:width 0.5s}
        .stat-fill.xp{background:linear-gradient(90deg,var(--gold-dim),var(--gold));box-shadow:0 0 8px var(--gold)}
        #realms{position:absolute;top:50%;left:10px;transform:translateY(-50%);display:flex;flex-direction:column;gap:4px;pointer-events:auto}
        .realm{width:38px;height:38px;border-radius:10px;background:var(--glass);border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;transition:all 0.25s;position:relative}
        .realm:hover{background:var(--glass-hover);transform:translateX(4px)}
        .realm.active{background:rgba(232,197,71,0.15);border-color:var(--gold-dim);box-shadow:0 0 20px rgba(232,197,71,0.2)}
        .realm.locked{opacity:0.3;cursor:not-allowed}
        .realm.locked:hover{transform:none;background:var(--glass)}
        .realm-tip{position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);padding:6px 10px;background:rgba(8,8,16,0.95);border:1px solid var(--glass-border);border-radius:8px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:100}
        .realm-tip-name{font-size:0.7rem;font-weight:500}
        .realm-tip-desc{font-size:0.55rem;color:var(--text-dim);margin-top:2px}
        .realm-tip-lock{font-size:0.5rem;color:var(--gold);margin-top:3px}
        .realm:hover .realm-tip{opacity:1}
        .realm .count{position:absolute;top:-4px;right:-4px;min-width:16px;height:16px;background:var(--blue);border-radius:8px;font-size:0.5rem;font-weight:600;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid var(--void)}
        #quick{position:absolute;top:50%;right:10px;transform:translateY(-50%);display:flex;flex-direction:column;gap:4px;pointer-events:auto}
        .quick-btn{width:38px;height:38px;border-radius:10px;background:var(--glass);border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;font-size:0.95rem;cursor:pointer;transition:all 0.25s;position:relative}
        .quick-btn:hover{background:var(--glass-hover);transform:translateX(-4px)}
        .quick-tip{position:absolute;right:calc(100% + 10px);top:50%;transform:translateY(-50%);padding:5px 9px;background:rgba(8,8,16,0.95);border:1px solid var(--glass-border);border-radius:6px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;font-size:0.6rem}
        .quick-btn:hover .quick-tip{opacity:1}
        .quick-btn .notif{position:absolute;top:-3px;right:-3px;width:10px;height:10px;background:var(--red);border-radius:50%;border:2px solid var(--void)}
        #action-bar{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:4px;padding:8px 12px;background:rgba(8,8,16,0.8);backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:28px;pointer-events:auto}
        .action{position:relative;width:42px;height:42px;border-radius:50%;background:var(--glass);border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;font-size:1.05rem;cursor:pointer;transition:all 0.2s}
        .action:hover{transform:translateY(-4px);background:var(--glass-hover);border-color:rgba(255,255,255,0.2);box-shadow:0 8px 24px rgba(0,0,0,0.4)}
        .action:active{transform:translateY(-2px) scale(0.95)}
        .action.primary{width:52px;height:52px;font-size:1.25rem;background:linear-gradient(135deg,rgba(232,197,71,0.2),rgba(232,197,71,0.05));border-color:var(--gold-dim)}
        .action.primary:hover{background:linear-gradient(135deg,rgba(232,197,71,0.3),rgba(232,197,71,0.1));box-shadow:0 8px 32px rgba(232,197,71,0.25)}
        .action-tip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);padding:4px 8px;background:rgba(5,5,12,0.95);border:1px solid var(--glass-border);border-radius:6px;font-size:0.55rem;letter-spacing:0.08em;text-transform:uppercase;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.15s}
        .action:hover .action-tip{opacity:1}
        .action-key{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:0.45rem;color:var(--text-dim)}
        .divider{width:1px;height:24px;background:var(--glass-border);margin:0 4px}
        #msg-box{position:absolute;bottom:88px;left:50%;transform:translateX(-50%);width:min(400px,90vw);opacity:0;pointer-events:none;transition:all 0.3s}
        #msg-box.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-8px)}
        #msg-target{text-align:center;font-size:0.6rem;color:var(--blue);margin-bottom:5px;opacity:0;transition:opacity 0.2s}
        #msg-target.show{opacity:1}
        #msg-input{width:100%;padding:12px 20px;background:rgba(8,8,16,0.92);backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:26px;color:white;font-size:0.82rem;font-family:'Outfit',sans-serif;outline:none;text-align:center}
        #msg-input::placeholder{color:var(--text-dim);font-style:italic}
        #msg-input:focus{border-color:var(--gold-dim);box-shadow:0 0 40px rgba(232,197,71,0.15)}
        #msg-hint{text-align:center;margin-top:6px;font-size:0.52rem;color:var(--text-dim);letter-spacing:0.1em}
        #hint{position:absolute;bottom:145px;left:50%;transform:translateX(-50%);color:var(--text-dim);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;animation:hintFade 5s infinite;text-align:center;max-width:90%}
        @keyframes hintFade{0%,100%{opacity:0.2}50%{opacity:0.5}}
        #minimap{position:absolute;bottom:88px;right:16px;width:100px;height:100px;background:rgba(8,8,16,0.85);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:12px;overflow:hidden;pointer-events:auto}
        #mm-canvas{width:100%;height:100%}
        #mm-coords{position:absolute;top:4px;left:50%;transform:translateX(-50%);font-size:0.45rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace}
        #mm-label{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);font-size:0.45rem;color:var(--text-dim);letter-spacing:0.12em;text-transform:uppercase}
        .panel{position:absolute;background:rgba(8,8,16,0.95);backdrop-filter:blur(28px);border:1px solid var(--glass-border);border-radius:16px;pointer-events:auto;opacity:0;transform:scale(0.95);transition:all 0.3s;display:none;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
        .panel.show{opacity:1;transform:scale(1);display:flex;flex-direction:column}
        .panel-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--glass-border);flex-shrink:0}
        .panel-title{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:400}
        .panel-close{width:24px;height:24px;border-radius:8px;background:rgba(255,255,255,0.05);border:none;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all 0.2s}
        .panel-close:hover{background:rgba(255,255,255,0.1);color:white}
        .panel-tabs{display:flex;border-bottom:1px solid var(--glass-border);flex-shrink:0}
        .panel-tab{flex:1;padding:9px 8px;background:none;border:none;color:var(--text-dim);font-size:0.58rem;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;position:relative}
        .panel-tab:hover{color:var(--text-secondary);background:rgba(255,255,255,0.02)}
        .panel-tab.active{color:var(--gold)}
        .panel-tab.active::after{content:'';position:absolute;bottom:-1px;left:15%;right:15%;height:2px;background:var(--gold);border-radius:2px}
        .panel-tab .badge{font-size:0.5rem;background:var(--glass);padding:2px 5px;border-radius:6px;margin-left:4px}
        .panel-body{padding:10px;overflow-y:auto;flex:1}
        #social{top:58px;left:54px;width:260px;max-height:calc(100vh - 140px)}
        .player-card{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:10px;cursor:pointer;transition:all 0.2s;margin-bottom:4px;position:relative}
        .player-card:hover{background:rgba(255,255,255,0.05)}
        .player-card.speaking{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2)}
        .player-card.friend{border-left:2px solid var(--gold)}
        .player-card.offline{opacity:0.5}
        .player-orb{width:28px;height:28px;border-radius:50%;flex-shrink:0;position:relative}
        .player-orb .indicator{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid rgba(8,8,16,0.95)}
        .player-orb .indicator.online{background:var(--green)}
        .player-orb .indicator.offline{background:var(--text-dim)}
        .player-orb .speak-ring{position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--green);opacity:0}
        .player-card.speaking .speak-ring{opacity:1;animation:speakRing 1s infinite}
        .player-info{flex:1;min-width:0}
        .player-name{font-size:0.75rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .player-status{font-size:0.55rem;color:var(--text-dim)}
        .player-status.connected{color:var(--blue)}
        .player-status.speaking{color:var(--green)}
        .player-bond{width:32px;height:4px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;flex-shrink:0}
        .player-bond-fill{height:100%;background:linear-gradient(90deg,var(--pink),var(--blue));transition:width 0.3s}
        .empty-state{text-align:center;padding:24px 12px;color:var(--text-dim)}
        .empty-icon{font-size:2rem;margin-bottom:10px;opacity:0.4}
        .empty-text{font-size:0.75rem;line-height:1.5}
        #achievements{top:50%;left:50%;transform:translate(-50%,-50%) scale(0.95);width:min(560px,94vw);max-height:82vh}
        #achievements.show{transform:translate(-50%,-50%) scale(1)}
        .ach-summary{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:rgba(232,197,71,0.05);border-bottom:1px solid var(--glass-border)}
        .ach-progress{font-size:0.7rem;color:var(--text-secondary)}
        .ach-progress span{color:var(--gold);font-weight:600}
        .ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;padding:12px;overflow-y:auto;flex:1}
        .ach-card{padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);border-radius:10px;display:flex;gap:10px;transition:all 0.2s;cursor:pointer}
        .ach-card:hover{background:rgba(255,255,255,0.04);transform:translateY(-2px)}
        .ach-card.unlocked{background:rgba(232,197,71,0.08);border-color:rgba(232,197,71,0.3)}
        .ach-card.locked{opacity:0.4}
        .ach-card.secret{background:rgba(168,85,247,0.05);border-color:rgba(168,85,247,0.2)}
        .ach-icon{font-size:1.4rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--glass);border-radius:8px;flex-shrink:0}
        .ach-card.unlocked .ach-icon{background:rgba(232,197,71,0.15)}
        .ach-details{flex:1;min-width:0}
        .ach-name{font-size:0.72rem;font-weight:600;margin-bottom:2px}
        .ach-desc{font-size:0.58rem;color:var(--text-dim);line-height:1.35}
        .ach-reward{font-size:0.55rem;color:var(--gold);margin-top:4px}
        .ach-bar{height:3px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;margin-top:5px}
        .ach-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold-dim),var(--gold));transition:width 0.4s}
        #settings{top:50%;left:50%;transform:translate(-50%,-50%) scale(0.95);width:min(380px,92vw);max-height:82vh}
        #settings.show{transform:translate(-50%,-50%) scale(1)}
        .settings-section{padding:12px 14px;border-bottom:1px solid var(--glass-border)}
        .settings-section:last-child{border-bottom:none}
        .settings-title{font-size:0.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:10px}
        .setting-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;gap:10px}
        .setting-info{flex:1;min-width:0}
        .setting-label{font-size:0.78rem}
        .setting-desc{font-size:0.58rem;color:var(--text-dim);margin-top:2px}
        .toggle{width:40px;height:22px;background:rgba(255,255,255,0.1);border-radius:11px;cursor:pointer;position:relative;transition:all 0.25s;flex-shrink:0}
        .toggle.on{background:var(--gold)}
        .toggle-knob{position:absolute;top:2px;left:2px;width:18px;height:18px;background:white;border-radius:50%;transition:all 0.25s;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
        .toggle.on .toggle-knob{left:20px}
        .slider-row{display:flex;align-items:center;gap:10px;flex:1}
        .slider{flex:1;height:4px;background:rgba(255,255,255,0.1);border-radius:4px;cursor:pointer;position:relative}
        .slider-fill{height:100%;background:var(--gold);border-radius:4px;pointer-events:none}
        .slider-val{font-size:0.68rem;min-width:32px;text-align:right;color:var(--text-secondary)}
        .color-picker{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
        .color-opt{width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
        .color-opt:hover{transform:scale(1.15)}
        .color-opt.selected{border-color:white;box-shadow:0 0 12px currentColor}
        #quests{top:58px;right:54px;width:270px;max-height:calc(100vh - 140px)}
        .quest-timer{padding:10px 14px;background:linear-gradient(135deg,rgba(232,197,71,0.08),rgba(168,85,247,0.05));border-bottom:1px solid var(--glass-border);text-align:center}
        .quest-timer-label{font-size:0.5rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em}
        .quest-timer-val{font-size:0.85rem;font-weight:600;color:var(--gold);font-family:'JetBrains Mono',monospace;margin-top:2px}
        .quest-section{padding:10px 12px;border-bottom:1px solid var(--glass-border)}
        .quest-section:last-child{border-bottom:none}
        .quest-section-title{font-size:0.52rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .quest-card{padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:6px;transition:all 0.2s}
        .quest-card:hover{background:rgba(255,255,255,0.04)}
        .quest-card.complete{background:rgba(34,197,94,0.08);border-color:rgba(34,197,94,0.3)}
        .quest-card.weekly{border-left:2px solid var(--purple)}
        .quest-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
        .quest-name{font-size:0.72rem;font-weight:500}
        .quest-reward{font-size:0.58rem;color:var(--gold);display:flex;align-items:center;gap:3px}
        .quest-desc{font-size:0.6rem;color:var(--text-dim);margin-bottom:8px}
        .quest-progress{display:flex;align-items:center;gap:8px}
        .quest-bar{flex:1;height:4px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden}
        .quest-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--purple));transition:width 0.4s}
        .quest-card.complete .quest-bar-fill{background:var(--green)}
        .quest-count{font-size:0.58rem;color:var(--text-secondary);min-width:40px;text-align:right}
        #profile{position:absolute;width:280px;border-radius:14px;z-index:100}
        .prof-banner{height:65px;position:relative;overflow:hidden;border-radius:14px 14px 0 0}
        .prof-banner-bg{position:absolute;inset:0;opacity:0.5}
        .prof-avatar-wrap{position:absolute;bottom:-26px;left:14px}
        .prof-avatar{width:56px;height:56px;border-radius:50%;border:3px solid rgba(8,8,16,0.95);position:relative;overflow:hidden}
        .prof-avatar-inner{width:100%;height:100%;border-radius:50%}
        .prof-avatar.speaking::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:2px solid var(--green);animation:speakRing 1s infinite}
        .prof-friend-badge{position:absolute;top:-3px;right:-3px;width:18px;height:18px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.55rem;border:2px solid rgba(8,8,16,0.95)}
        .prof-content{padding:32px 14px 14px}
        .prof-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .prof-name{font-size:1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
        .prof-title{font-size:0.58rem;color:var(--gold);letter-spacing:0.1em;text-transform:uppercase;margin-top:2px}
        .prof-status{padding:3px 8px;border-radius:8px;font-size:0.52rem;display:flex;align-items:center;gap:4px}
        .prof-status.online{background:rgba(34,197,94,0.15);color:var(--green)}
        .prof-status.offline{background:var(--glass);color:var(--text-dim)}
        .prof-status.speaking{background:rgba(34,197,94,0.2);color:var(--green)}
        .prof-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px}
        .prof-stat{text-align:center;padding:8px 4px;background:rgba(255,255,255,0.03);border-radius:8px}
        .prof-stat-val{font-size:0.9rem;font-weight:600;color:var(--gold)}
        .prof-stat-label{font-size:0.48rem;color:var(--text-dim);text-transform:uppercase;margin-top:2px}
        .prof-bond{margin-bottom:12px}
        .prof-bond-head{display:flex;justify-content:space-between;margin-bottom:4px;font-size:0.58rem;color:var(--text-dim)}
        .prof-bond-bar{height:4px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden}
        .prof-bond-fill{height:100%;background:linear-gradient(90deg,var(--pink),var(--blue));transition:width 0.4s}
        .prof-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
        .prof-btn{padding:9px 8px;border-radius:8px;border:1px solid var(--glass-border);background:var(--glass);color:white;font-size:0.65rem;font-family:'Outfit',sans-serif;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:4px}
        .prof-btn:hover{background:var(--glass-hover);transform:translateY(-1px)}
        .prof-btn.primary{background:linear-gradient(135deg,var(--gold-dim),var(--gold));border:none;color:var(--void)}
        .prof-btn.primary:hover{filter:brightness(1.1)}
        .prof-btn.danger{border-color:rgba(239,68,68,0.3);color:var(--red)}
        .prof-btn.danger:hover{background:rgba(239,68,68,0.1)}
        #emotes{position:absolute;width:240px;height:240px;border-radius:50%;background:radial-gradient(circle,rgba(12,12,20,0.98) 0%,rgba(8,8,16,0.95) 100%);backdrop-filter:blur(24px);border:1px solid var(--glass-border);z-index:150;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
        #emotes.show{display:block;animation:emoteIn 0.25s cubic-bezier(0.34,1.56,0.64,1)}
        @keyframes emoteIn{from{opacity:0;transform:scale(0.7)}to{opacity:1;transform:scale(1)}}
        .emote{position:absolute;width:38px;height:38px;border-radius:50%;background:var(--glass);border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;font-size:1.15rem;cursor:pointer;transition:all 0.15s}
        .emote:hover{transform:scale(1.25);background:rgba(255,255,255,0.15);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
        .emote.locked{opacity:0.3;cursor:not-allowed}
        .emote.locked:hover{transform:none;background:var(--glass);box-shadow:none}
        .emote .lock{position:absolute;bottom:-2px;right:-2px;width:14px;height:14px;background:var(--glass);border-radius:50%;font-size:0.4rem;display:flex;align-items:center;justify-content:center;border:1px solid var(--glass-border)}
        #emote-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:0.6rem;color:var(--text-dim);text-align:center}
        #toasts{position:absolute;top:70px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:6px;z-index:200;pointer-events:none;max-width:90%}
        .toast{padding:10px 16px;background:rgba(12,12,20,0.95);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:12px;font-size:0.72rem;display:flex;align-items:center;gap:8px;animation:toastIn 0.35s cubic-bezier(0.34,1.56,0.64,1),toastOut 0.3s ease 4s forwards;pointer-events:auto;white-space:nowrap;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
        @keyframes toastIn{from{opacity:0;transform:translateY(-16px) scale(0.9)}to{opacity:1;transform:translateY(0) scale(1)}}
        @keyframes toastOut{to{opacity:0;transform:translateY(-12px)}}
        .toast.achievement{border-color:rgba(232,197,71,0.4);background:linear-gradient(135deg,rgba(232,197,71,0.12),rgba(12,12,20,0.95))}
        .toast.quest{border-color:rgba(34,197,94,0.4);background:linear-gradient(135deg,rgba(34,197,94,0.12),rgba(12,12,20,0.95))}
        .toast.level{border-color:rgba(168,85,247,0.4);background:linear-gradient(135deg,rgba(168,85,247,0.12),rgba(12,12,20,0.95))}
        .toast.friend{border-color:rgba(255,107,157,0.4);background:linear-gradient(135deg,rgba(255,107,157,0.12),rgba(12,12,20,0.95))}
        .toast.voice{border-color:rgba(78,205,196,0.4);background:linear-gradient(135deg,rgba(78,205,196,0.12),rgba(12,12,20,0.95))}
        .toast-icon{font-size:1rem}
        .toast-content{flex:1}
        .toast-title{font-weight:600}
        .toast-desc{font-size:0.62rem;color:var(--text-secondary);margin-top:2px}
        #loading{position:absolute;inset:0;background:var(--void);z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;transition:opacity 1.5s}
        #loading.hide{opacity:0;pointer-events:none}
        #loading h1{font-family:'Cormorant Garamond',serif;font-weight:300;letter-spacing:0.7em;color:var(--gold);font-size:clamp(2.2rem,12vw,4rem);margin-bottom:6px;text-shadow:0 0 60px rgba(232,197,71,0.4);animation:glow 3s infinite}
        #loading-sub{font-size:0.75rem;letter-spacing:0.35em;color:var(--text-dim);text-transform:uppercase;margin-bottom:40px}
        #loading-features{display:flex;justify-content:center;gap:clamp(20px,6vw,40px);margin-bottom:32px;flex-wrap:wrap}
        .feat{text-align:center}
        .feat-icon{font-size:1.8rem;margin-bottom:6px;animation:float 3s infinite}
        .feat:nth-child(2) .feat-icon{animation-delay:0.4s}
        .feat:nth-child(3) .feat-icon{animation-delay:0.8s}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
        .feat-text{font-size:0.55rem;color:var(--text-secondary);letter-spacing:0.12em;text-transform:uppercase}
        #loading p{color:var(--text-secondary);font-size:0.78rem;line-height:1.7;text-align:center;max-width:400px;margin-bottom:32px}
        #name-input{width:min(240px,80vw);padding:12px 20px;background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:24px;color:white;font-size:0.85rem;font-family:'Outfit',sans-serif;text-align:center;outline:none;margin-bottom:16px}
        #name-input::placeholder{color:var(--text-dim)}
        #name-input:focus{border-color:var(--gold-dim);box-shadow:0 0 32px rgba(232,197,71,0.15)}
        #start-btn{padding:14px 50px;background:transparent;border:2px solid var(--gold);color:var(--gold);font-family:'Outfit',sans-serif;font-size:0.75rem;letter-spacing:0.3em;text-transform:uppercase;cursor:pointer;transition:all 0.35s;font-weight:600}
        #start-btn:hover{background:var(--gold);color:var(--void);box-shadow:0 0 40px rgba(232,197,71,0.5);transform:translateY(-2px)}
        #onboard{position:absolute;inset:0;background:rgba(3,3,8,0.9);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
        #onboard.show{display:flex}
        .ob-card{max-width:400px;width:100%;padding:clamp(20px,5vw,32px);background:rgba(10,10,18,0.98);backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:20px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,0.5);animation:obIn 0.5s cubic-bezier(0.34,1.56,0.64,1)}
        @keyframes obIn{from{opacity:0;transform:translateY(20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}
        .ob-icon{font-size:3.5rem;margin-bottom:16px;animation:obFloat 3s infinite}
        @keyframes obFloat{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-8px) rotate(3deg)}}
        .ob-title{font-family:'Cormorant Garamond',serif;font-size:1.6rem;margin-bottom:12px}
        .ob-text{color:var(--text-secondary);line-height:1.7;margin-bottom:20px;font-size:0.8rem}
        .ob-keys{display:flex;justify-content:center;gap:8px;margin-bottom:20px;flex-wrap:wrap}
        .ob-key{padding:6px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);border-radius:6px;font-size:0.65rem;display:flex;align-items:center;gap:4px}
        .ob-key-icon{font-size:0.9rem}
        .ob-btn{padding:12px 32px;background:var(--gold);border:none;border-radius:10px;color:var(--void);font-family:'Outfit',sans-serif;font-size:0.75rem;font-weight:600;letter-spacing:0.1em;cursor:pointer;transition:all 0.3s}
        .ob-btn:hover{filter:brightness(1.1);transform:translateY(-2px);box-shadow:0 8px 24px rgba(232,197,71,0.35)}
        #realm-trans{position:absolute;inset:0;background:var(--void);z-index:400;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.6s}
        #realm-trans.active{opacity:1;pointer-events:auto}
        .trans-icon{font-size:3rem;margin-bottom:12px;animation:transPulse 1.5s infinite}
        @keyframes transPulse{0%,100%{transform:scale(1);opacity:0.7}50%{transform:scale(1.15);opacity:1}}
        .trans-name{font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300;letter-spacing:0.25em;color:var(--gold)}
        .trans-desc{font-size:0.7rem;color:var(--text-dim);margin-top:8px;letter-spacing:0.15em}
        @media(max-width:768px){#top{padding:8px 10px}#logo{font-size:1rem;letter-spacing:0.4em}#realm-pill,#streak-pill{display:none}#voice-panel{padding:3px 6px}#voice-status{display:none}#identity{padding:4px 10px 4px 6px;gap:6px}#my-orb{width:26px;height:26px}#my-name{max-width:65px;font-size:0.72rem}#my-title{font-size:0.5rem}#stats{display:none}#realms{left:6px}.realm{width:32px;height:32px;font-size:0.9rem}.realm-tip{display:none}#quick{right:6px}.quick-btn{width:32px;height:32px;font-size:0.85rem}.quick-tip{display:none}#minimap{width:70px;height:70px;bottom:75px;right:8px}#mm-label,#mm-coords{display:none}.action{width:36px;height:36px;font-size:0.95rem}.action.primary{width:44px;height:44px;font-size:1.1rem}.action-tip,.action-key{display:none}#hint{font-size:0.52rem;bottom:130px}#social,#quests{width:calc(100% - 16px);left:8px;right:8px;top:50px;max-height:calc(100vh - 120px)}#profile{width:calc(100% - 16px);max-width:280px;left:8px !important}#achievements,#settings{width:calc(100% - 16px);max-height:calc(100vh - 40px)}.ach-grid{grid-template-columns:1fr}#msg-box{bottom:75px;width:calc(100% - 20px)}}
        @media(max-width:400px){#action-bar{padding:5px 8px;gap:2px}.action{width:32px;height:32px;font-size:0.85rem}.action.primary{width:40px;height:40px;font-size:1rem}.divider{margin:0 2px;height:18px}}
        ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.12);border-radius:4px}
        ::selection{background:rgba(232,197,71,0.3)}
    </style>
</head>
<body>
<div id="loading"><h1>AURA</h1><div id="loading-sub">The Social Cosmos</div><div id="loading-features"><div class="feat"><div class="feat-icon">üåå</div><div class="feat-text">8 Realms</div></div><div class="feat"><div class="feat-icon">üéôÔ∏è</div><div class="feat-text">Spatial Voice</div></div><div class="feat"><div class="feat-icon">‚ú®</div><div class="feat-text">24 Achievements</div></div></div><p>Drift through an infinite cosmos of connection.<br>Make friends. Form constellations. Leave your mark.</p><input type="text" id="name-input" placeholder="Choose your cosmic name..." maxlength="20" autocomplete="off"><button id="start-btn">Enter the Cosmos</button></div>
<div id="onboard"><div class="ob-card"><div class="ob-icon">üåü</div><div class="ob-title">Welcome to the Cosmos</div><p class="ob-text">You are a spark of light in an infinite universe. Move to drift through space. Connect with other souls to grow brighter.</p><div class="ob-keys"><div class="ob-key"><span class="ob-key-icon">üí¨</span> Whisper</div><div class="ob-key"><span class="ob-key-icon">üéµ</span> Sing</div><div class="ob-key"><span class="ob-key-icon">‚ú®</span> Pulse</div><div class="ob-key"><span class="ob-key-icon">‚≠ê</span> Echo</div></div><button class="ob-btn" id="ob-go">Begin Your Journey</button></div></div>
<div id="realm-trans"><div style="text-align:center"><div class="trans-icon" id="trans-icon">üåå</div><div class="trans-name" id="trans-name">Genesis</div><div class="trans-desc" id="trans-desc">The birthplace of all things</div></div></div>
<div id="cursor"></div>
<canvas id="canvas"></canvas>
<div id="ui">
<div id="top"><div id="logo-area"><div id="logo">AURA</div><div id="realm-pill"><span id="realm-icon">üåå</span><span id="realm-name">Genesis</span></div><div id="streak-pill"><span class="fire">üî•</span> <span id="streak-count">0</span> Day Streak</div></div><div id="top-right"><div id="voice-panel"><button class="voice-btn muted" id="voice-btn" title="Toggle Voice (V)">üîá</button><div id="voice-viz"><div class="vbar" style="height:3px"></div><div class="vbar" style="height:5px"></div><div class="vbar" style="height:8px"></div><div class="vbar" style="height:5px"></div><div class="vbar" style="height:3px"></div></div><span id="voice-status">Off</span></div><div id="identity"><div id="my-orb"><div class="lvl" id="lvl-badge">1</div></div><div id="my-info"><div id="my-name">Wanderer</div><div id="my-title">Spark</div></div></div></div></div>
<div id="stats"><div class="stat"><div class="stat-icon">‚ö°</div><div class="stat-content"><div class="stat-label">Experience</div><div class="stat-val" id="xp-val">0 / 100</div><div class="stat-bar"><div class="stat-fill xp" id="xp-fill" style="width:0%"></div></div></div></div><div class="stat"><div class="stat-icon">üí´</div><div class="stat-content"><div class="stat-label">Connections</div><div class="stat-val" id="conn-val">0</div></div></div><div class="stat"><div class="stat-icon">üë•</div><div class="stat-content"><div class="stat-label">Friends</div><div class="stat-val" id="friend-val">0</div></div></div><div class="stat"><div class="stat-icon">‚≠ê</div><div class="stat-content"><div class="stat-label">Stars</div><div class="stat-val" id="stars-val">0</div></div></div></div>
<div id="realms"></div>
<div id="quick"><div class="quick-btn" id="btn-quests"><span class="quick-tip">Quests</span>üìã</div><div class="quick-btn" id="btn-ach"><span class="quick-tip">Achievements</span>üèÜ</div><div class="quick-btn" id="btn-settings"><span class="quick-tip">Settings</span>‚öôÔ∏è</div></div>
<div id="hint">Move to drift ‚Ä¢ Click souls to connect ‚Ä¢ V for voice ‚Ä¢ F to add friends</div>
<div id="msg-box"><div id="msg-target"></div><input type="text" id="msg-input" placeholder="Whisper into the void..." maxlength="120" autocomplete="off"><div id="msg-hint">Enter to send ‚Ä¢ Escape to cancel</div></div>
<div id="action-bar"><button class="action" id="btn-social">üë•<span class="action-tip">Cosmos</span><span class="action-key">Tab</span></button><div class="divider"></div><button class="action" id="btn-whisper">üí¨<span class="action-tip">Whisper</span><span class="action-key">W</span></button><button class="action primary" id="btn-sing">üéµ<span class="action-tip">Sing</span><span class="action-key">S</span></button><button class="action" id="btn-pulse">‚ú®<span class="action-tip">Pulse</span><span class="action-key">P</span></button><button class="action" id="btn-echo">‚≠ê<span class="action-tip">Echo</span><span class="action-key">E</span></button><div class="divider"></div><button class="action" id="btn-emote">üòä<span class="action-tip">Emote</span><span class="action-key">Q</span></button></div>
<div id="minimap"><canvas id="mm-canvas"></canvas><div id="mm-coords">0, 0</div><div id="mm-label">Local</div></div>
<div class="panel" id="social"><div class="panel-head"><div><div class="panel-title">Cosmos</div></div><button class="panel-close" data-panel="social">√ó</button></div><div class="panel-tabs"><button class="panel-tab active" data-tab="nearby">Nearby</button><button class="panel-tab" data-tab="friends">Friends <span class="badge" id="friends-badge">0</span></button><button class="panel-tab" data-tab="recent">Recent</button></div><div class="panel-body" id="social-list"></div></div>
<div class="panel" id="achievements"><div class="panel-head"><div><div class="panel-title">Achievements</div></div><button class="panel-close" data-panel="achievements">√ó</button></div><div class="ach-summary"><div class="ach-progress">Unlocked: <span id="ach-count">0</span> / <span id="ach-total">24</span></div></div><div class="panel-tabs"><button class="panel-tab active" data-achtab="all">All</button><button class="panel-tab" data-achtab="social">Social</button><button class="panel-tab" data-achtab="explore">Explore</button><button class="panel-tab" data-achtab="secret">Secret</button></div><div class="ach-grid" id="ach-grid"></div></div>
<div class="panel" id="settings"><div class="panel-head"><div><div class="panel-title">Settings</div></div><button class="panel-close" data-panel="settings">√ó</button></div><div class="panel-body"><div class="settings-section"><div class="settings-title">üîä Audio</div><div class="setting-row"><div class="setting-info"><div class="setting-label">Ambient Music</div></div><div class="toggle on" data-setting="music"><div class="toggle-knob"></div></div></div><div class="setting-row"><div class="setting-info"><div class="setting-label">Volume</div></div><div class="slider-row"><div class="slider" data-setting="volume"><div class="slider-fill" style="width:70%"></div></div><div class="slider-val">70%</div></div></div><div class="setting-row"><div class="setting-info"><div class="setting-label">Sound Effects</div></div><div class="toggle on" data-setting="sfx"><div class="toggle-knob"></div></div></div></div><div class="settings-section"><div class="settings-title">üéôÔ∏è Voice</div><div class="setting-row"><div class="setting-info"><div class="setting-label">Push to Talk</div><div class="setting-desc">Hold Space to transmit</div></div><div class="toggle" data-setting="ptt"><div class="toggle-knob"></div></div></div><div class="setting-row"><div class="setting-info"><div class="setting-label">Voice Activity</div></div><div class="toggle on" data-setting="vad"><div class="toggle-knob"></div></div></div></div><div class="settings-section"><div class="settings-title">üé® Appearance</div><div class="setting-row"><div class="setting-info"><div class="setting-label">Aura Color</div></div></div><div class="color-picker" id="color-picker"></div></div><div class="settings-section"><div class="settings-title">‚ú® Effects</div><div class="setting-row"><div class="setting-info"><div class="setting-label">Particles</div></div><div class="toggle on" data-setting="particles"><div class="toggle-knob"></div></div></div><div class="setting-row"><div class="setting-info"><div class="setting-label">Screen Shake</div></div><div class="toggle on" data-setting="shake"><div class="toggle-knob"></div></div></div><div class="setting-row"><div class="setting-info"><div class="setting-label">Glow Effects</div></div><div class="toggle on" data-setting="glow"><div class="toggle-knob"></div></div></div></div></div></div>
<div class="panel" id="quests"><div class="panel-head"><div><div class="panel-title">Quests</div></div><button class="panel-close" data-panel="quests">√ó</button></div><div class="quest-timer"><div class="quest-timer-label">Daily Reset In</div><div class="quest-timer-val" id="quest-timer">00:00:00</div></div><div class="panel-body" id="quests-list"></div></div>
<div class="panel" id="profile"><div class="prof-banner"><div class="prof-banner-bg" id="prof-banner"></div><div class="prof-avatar-wrap"><div class="prof-avatar" id="prof-avatar-wrap"><div class="prof-avatar-inner" id="prof-avatar"></div></div><div class="prof-friend-badge" id="prof-friend-badge" style="display:none">‚≠ê</div></div></div><div class="prof-content"><div class="prof-header"><div><div class="prof-name" id="prof-name">Unknown</div><div class="prof-title" id="prof-title">Spark ‚Ä¢ Lv 1</div></div><div class="prof-status online" id="prof-status"><span>‚óè</span> Online</div></div><div class="prof-stats"><div class="prof-stat"><div class="prof-stat-val" id="prof-stars">0</div><div class="prof-stat-label">Stars</div></div><div class="prof-stat"><div class="prof-stat-val" id="prof-echoes">0</div><div class="prof-stat-label">Echoes</div></div><div class="prof-stat"><div class="prof-stat-val" id="prof-age">0h</div><div class="prof-stat-label">Age</div></div></div><div class="prof-bond"><div class="prof-bond-head"><span>Connection</span><span id="prof-bond-val">0%</span></div><div class="prof-bond-bar"><div class="prof-bond-fill" id="prof-bond-fill" style="width:0%"></div></div></div><div class="prof-actions"><button class="prof-btn" id="prof-whisper">üí¨ Whisper</button><button class="prof-btn primary" id="prof-follow">üìç Follow</button><button class="prof-btn" id="prof-friend">‚≠ê Add Friend</button><button class="prof-btn" id="prof-teleport">üöÄ Teleport</button></div></div></div>
<div class="panel" id="emotes" style="display:none"><div id="emote-center">Pick an<br>emote</div></div>
<div id="toasts"></div>
</div>
<script>
// AURA Ultimate - Complete Game Engine
const C={FORMS:['Spark','Ember','Flame','Prism','Nova','Celestial','Eternal','Infinite','Ascended','Transcendent'],LVL_XP:[0,100,300,700,1500,3000,6000,12000,25000,50000,100000],DRIFT:0.035,CAM_EASE:0.08,TETHER:400,VIEW_R:550,VIEW_BOND:45,BOND_DECAY:0.055,BOND_GAIN:12,VOICE_R:650,STAR_CELL:200,MM_R:2500,MAX_PARTS:250,WHISP_SPEED:5.8,WHISP_LIFE:350,CD_SING:2000,CD_PULSE:3000,CD_ECHO:5000};
const SCALES={genesis:[261.63,293.66,329.63,392,440,523.25],nebula:[277.18,311.13,369.99,415.3,466.16,554.37],void:[130.81,146.83,164.81,196,220,261.63],starforge:[293.66,329.63,369.99,440,493.88,587.33],sanctuary:[246.94,293.66,329.63,392,440,493.88],abyss:[110,130.81,146.83,174.61,196,220],crystal:[329.63,369.99,415.3,493.88,554.37,622.25],celestial:[440,493.88,554.37,659.25,739.99,880]};
const REALMS={genesis:{name:'Genesis',icon:'üåå',bg:[5,5,12],n1:[78,205,196],n2:[255,107,157],unlock:1,desc:'The birthplace',drone:55},nebula:{name:'Nebula Gardens',icon:'üå∏',bg:[15,5,20],n1:[255,107,157],n2:[168,85,247],unlock:1,desc:'Where echoes bloom',drone:62},void:{name:'The Void',icon:'üåë',bg:[2,2,5],n1:[30,30,60],n2:[20,20,40],unlock:1,desc:'Embrace darkness',drone:41},starforge:{name:'Starforge',icon:'üî•',bg:[15,8,5],n1:[255,140,0],n2:[255,69,0],unlock:5,desc:'Born of fire',drone:73},sanctuary:{name:'Sanctuary',icon:'üèõÔ∏è',bg:[8,12,18],n1:[100,149,237],n2:[135,206,250],unlock:10,desc:'A haven of peace',drone:49},abyss:{name:'The Abyss',icon:'üåä',bg:[3,8,15],n1:[0,100,150],n2:[0,50,100],unlock:15,desc:'Depths unknown',drone:36},crystal:{name:'Crystal Caverns',icon:'üíé',bg:[12,8,18],n1:[200,150,255],n2:[150,100,200],unlock:20,desc:'Prismatic wonder',drone:82},celestial:{name:'Celestial Throne',icon:'üëë',bg:[15,12,5],n1:[255,215,0],n2:[255,180,0],unlock:25,desc:'For the ascended',drone:110}};
const EMOTES=[{e:'üëã',u:1},{e:'üí´',u:1},{e:'‚ù§Ô∏è',u:1},{e:'üéâ',u:1},{e:'üåü',u:1},{e:'‚ú®',u:1},{e:'üòä',u:1},{e:'ü§ù',u:1},{e:'üî•',u:3},{e:'üí≠',u:3},{e:'üëÄ',u:3},{e:'üíï',u:5},{e:'üéµ',u:5},{e:'üåà',u:7},{e:'‚ö°',u:10},{e:'üëë',u:15}];
const ACHS=[{id:'first_whisper',name:'First Words',desc:'Send your first whisper',icon:'üí¨',reward:10,track:'whispers',need:1,cat:'social'},{id:'chatterbox',name:'Chatterbox',desc:'Send 50 whispers',icon:'üó£Ô∏è',reward:50,track:'whispers',need:50,cat:'social'},{id:'storyteller',name:'Storyteller',desc:'Send 200 whispers',icon:'üìö',reward:100,track:'whispers',need:200,cat:'social'},{id:'first_conn',name:'Kindred Spirit',desc:'Form your first connection',icon:'üí´',reward:25,track:'connections',need:1,cat:'social'},{id:'social',name:'Social Butterfly',desc:'Connect with 10 souls',icon:'ü¶ã',reward:75,track:'connections',need:10,cat:'social'},{id:'networker',name:'Cosmic Networker',desc:'Connect with 50 souls',icon:'üåê',reward:150,track:'connections',need:50,cat:'social'},{id:'first_friend',name:'First Friend',desc:'Add your first friend',icon:'ü§ù',reward:30,track:'friends',need:1,cat:'social'},{id:'popular',name:'Popular',desc:'Have 10 friends',icon:'‚≠ê',reward:100,track:'friends',need:10,cat:'social'},{id:'bond100',name:'Deep Bond',desc:'100% bond with someone',icon:'üíû',reward:60,track:'maxBond',need:100,cat:'social'},{id:'star10',name:'Star Lighter',desc:'Light 10 stars',icon:'‚≠ê',reward:20,track:'stars',need:10,cat:'explore'},{id:'star100',name:'Star Collector',desc:'Light 100 stars',icon:'üåå',reward:100,track:'stars',need:100,cat:'explore'},{id:'star500',name:'Constellation Master',desc:'Light 500 stars',icon:'‚ú®',reward:200,track:'stars',need:500,cat:'explore'},{id:'echo5',name:'Echo Planter',desc:'Plant 5 echoes',icon:'üå±',reward:30,track:'echoes',need:5,cat:'explore'},{id:'echo25',name:'Echo Gardener',desc:'Plant 25 echoes',icon:'üåø',reward:80,track:'echoes',need:25,cat:'explore'},{id:'realm3',name:'Realm Explorer',desc:'Visit 3 realms',icon:'üó∫Ô∏è',reward:40,track:'realmsVisited',need:3,cat:'explore'},{id:'realm_all',name:'Realm Master',desc:'Visit all 8 realms',icon:'üèÜ',reward:200,track:'realmsVisited',need:8,cat:'explore'},{id:'voice',name:'Voice Pioneer',desc:'Use voice chat',icon:'üéôÔ∏è',reward:15,track:'voiceUsed',need:1,cat:'explore'},{id:'lv5',name:'Nova',desc:'Reach Level 5',icon:'üí•',reward:50,track:'level',need:5,cat:'explore'},{id:'lv10',name:'Celestial',desc:'Reach Level 10',icon:'üå†',reward:100,track:'level',need:10,cat:'explore'},{id:'lv20',name:'Eternal',desc:'Reach Level 20',icon:'‚ôæÔ∏è',reward:200,track:'level',need:20,cat:'explore'},{id:'night_owl',name:'Night Owl',desc:'Play after midnight',icon:'ü¶â',reward:25,track:'nightOwl',need:1,cat:'secret',secret:true},{id:'marathon',name:'Marathon',desc:'Play for 2 hours',icon:'üèÉ',reward:50,track:'marathon',need:1,cat:'secret',secret:true},{id:'constellation',name:'Constellation',desc:'Form a 3+ player group',icon:'‚≠ê',reward:75,track:'constellation',need:1,cat:'secret',secret:true},{id:'teleporter',name:'Teleporter',desc:'Teleport to a friend',icon:'üöÄ',reward:30,track:'teleports',need:1,cat:'secret',secret:true}];
const D_QUESTS=[{id:'d_whisper',name:'Cosmic Messenger',desc:'Send 3 whispers',icon:'üí¨',reward:15,track:'whispers',need:3},{id:'d_stars',name:'Illuminate',desc:'Light 5 stars',icon:'‚≠ê',reward:10,track:'stars',need:5},{id:'d_connect',name:'Make a Friend',desc:'Form a connection',icon:'üí´',reward:20,track:'connections',need:1},{id:'d_sing',name:'Cosmic Harmony',desc:'Sing 2 times',icon:'üéµ',reward:10,track:'sings',need:2},{id:'d_emote',name:'Express Yourself',desc:'Use 3 emotes',icon:'üòä',reward:10,track:'emotes',need:3}];
const W_QUESTS=[{id:'w_whisper',name:'Weekly Messenger',desc:'Send 50 whispers',icon:'üì®',reward:75,track:'whispers',need:50},{id:'w_stars',name:'Star Hunter',desc:'Light 100 stars',icon:'üåü',reward:100,track:'stars',need:100},{id:'w_friends',name:'Friendship Week',desc:'Add 3 friends',icon:'ü§ù',reward:80,track:'newFriends',need:3},{id:'w_realms',name:'Realm Hopper',desc:'Visit 5 realms',icon:'üåå',reward:60,track:'realmChanges',need:5}];

let game=false,realm='genesis',selId=null,socTab='nearby',achTab='all',msgMode=null,directTgt=null,sessStart=Date.now();
let panels={social:false,achievements:false,settings:false,quests:false,profile:false,emotes:false};
let settings={music:true,volume:0.7,sfx:true,ptt:false,vad:true,sensitivity:0.5,particles:true,shake:true,glow:true,hue:Math.random()*360};
let stats={whispers:0,stars:0,echoes:0,connections:0,friends:0,maxBond:0,voiceUsed:0,level:1,realmsVisited:1,nightOwl:0,marathon:0,constellation:0,teleports:0,sings:0,pulses:0,emotes:0};
let daily={date:new Date().toDateString()},weekly={week:getWeekNum()},unlocked=new Set(),friends=new Set(),recent=new Map(),visited=new Set(['genesis']),cds={sing:0,pulse:0,echo:0};

function getWeekNum(){const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));const y=new Date(d.getFullYear(),0,1);return Math.ceil((((d-y)/86400000)+1)/7)}
function getLvl(xp){for(let i=C.LVL_XP.length-1;i>=0;i--)if(xp>=C.LVL_XP[i])return i+1;return 1}
function getForm(l){return C.FORMS[Math.min(l-1,C.FORMS.length-1)]}
function getViewR(){return C.VIEW_R+[...player.bonds.values()].filter(b=>b>25).length*C.VIEW_BOND}
function formatTime(ms){const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);return`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`}
function getResetTime(){const n=new Date(),t=new Date(n);t.setDate(t.getDate()+1);t.setHours(0,0,0,0);return t-n}
function seed(s){const x=Math.sin(s)*43758.5453;return x-Math.floor(x)}

function saveAll(){try{localStorage.setItem('aura_settings',JSON.stringify(settings));localStorage.setItem('aura_stats',JSON.stringify(stats));localStorage.setItem('aura_daily',JSON.stringify(daily));localStorage.setItem('aura_weekly',JSON.stringify(weekly));localStorage.setItem('aura_unlocked',JSON.stringify([...unlocked]));localStorage.setItem('aura_friends',JSON.stringify([...friends]));localStorage.setItem('aura_player',JSON.stringify({name:player.name,xp:player.xp,stars:player.stars,echoes:player.echoes}))}catch(e){}}
function loadAll(){try{const s=localStorage.getItem('aura_settings');if(s)settings={...settings,...JSON.parse(s)};const st=localStorage.getItem('aura_stats');if(st)stats={...stats,...JSON.parse(st)};const d=localStorage.getItem('aura_daily');if(d){const p=JSON.parse(d);if(p.date===new Date().toDateString())daily=p;else daily={date:new Date().toDateString()}}const w=localStorage.getItem('aura_weekly');if(w){const p=JSON.parse(w);if(p.week===getWeekNum())weekly=p;else weekly={week:getWeekNum()}}const u=localStorage.getItem('aura_unlocked');if(u)unlocked=new Set(JSON.parse(u));const f=localStorage.getItem('aura_friends');if(f)friends=new Set(JSON.parse(f));const pl=localStorage.getItem('aura_player');if(pl){const data=JSON.parse(pl);player.xp=data.xp||0;player.stars=data.stars||0;player.echoes=data.echoes||0}player.hue=settings.hue}catch(e){}}

const Audio={ctx:null,master:null,drone:null,droneGain:null,init(){if(this.ctx)return;this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.master=this.ctx.createGain();this.master.gain.value=settings.volume*0.5;this.master.connect(this.ctx.destination);this.droneGain=this.ctx.createGain();this.droneGain.gain.value=0;this.droneGain.connect(this.master);this.drone=this.ctx.createOscillator();this.drone.type='sine';this.drone.frequency.value=REALMS[realm].drone;this.drone.connect(this.droneGain);this.drone.start();const lfo=this.ctx.createOscillator();lfo.frequency.value=0.05;const lg=this.ctx.createGain();lg.gain.value=1.5;lfo.connect(lg);lg.connect(this.drone.frequency);lfo.start()},setVol(v){settings.volume=v;if(this.master)this.master.gain.value=v*0.5},startDrone(){if(!this.ctx||!settings.music)return;if(this.ctx.state==='suspended')this.ctx.resume();this.droneGain.gain.setTargetAtTime(0.025,this.ctx.currentTime,2)},stopDrone(){if(this.droneGain)this.droneGain.gain.setTargetAtTime(0,this.ctx.currentTime,1)},setRealmTone(r){if(this.drone)this.drone.frequency.setTargetAtTime(REALMS[r].drone,this.ctx.currentTime,2)},note(freq,vol=0.08,dur=2){if(!this.ctx||!settings.sfx)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='sine';o.frequency.value=freq;const t=this.ctx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(vol*settings.volume,t+0.05);g.gain.exponentialRampToValueAtTime(0.001,t+dur);o.connect(g);g.connect(this.master);o.start(t);o.stop(t+dur)},chord(i=1){const s=SCALES[realm]||SCALES.genesis,b=s[Math.floor(Math.random()*s.length)],v=0.035*i;this.note(b,v,1.5);setTimeout(()=>this.note(b*1.25,v*0.75,1.3),50);setTimeout(()=>this.note(b*1.5,v*0.55,1.1),100)},sing(){this.chord(1.1)},pulse(){this.note(110,0.06,2);setTimeout(()=>this.note(165,0.05,1.7),80);setTimeout(()=>this.note(220,0.04,1.3),160)},echo(){const s=SCALES[realm]||SCALES.genesis;[0,2,4,5].forEach((n,i)=>setTimeout(()=>this.note(s[n%s.length],0.04,1.2),i*130))},levelUp(){const s=SCALES[realm]||SCALES.genesis;[0,2,4,5,4,5,7].forEach((n,i)=>setTimeout(()=>this.note(s[n%s.length],0.045,1),i*80))},conn(){this.note((SCALES[realm]||SCALES.genesis)[4],0.03,0.5)},whisperSend(){const s=SCALES[realm]||SCALES.genesis;this.note(s[4],0.035,0.6);setTimeout(()=>this.note(s[5],0.03,0.4),60)},whisperRecv(){const s=SCALES[realm]||SCALES.genesis;this.note(s[2],0.045,0.8);setTimeout(()=>this.note(s[4],0.035,0.6),80)},realmTrans(){const s=SCALES[realm]||SCALES.genesis;[5,4,2,0,2,4,5].forEach((n,i)=>setTimeout(()=>this.note(s[n%s.length],0.04,1),i*70))},ach(){const s=SCALES[realm]||SCALES.genesis;[0,2,4,7,4,5].forEach((n,i)=>setTimeout(()=>this.note(s[n%s.length],0.05,0.8),i*90))},quest(){const s=SCALES[realm]||SCALES.genesis;[4,5,7].forEach((n,i)=>setTimeout(()=>this.note(s[n%s.length],0.04,0.6),i*100))},friendAdd(){const s=SCALES[realm]||SCALES.genesis;[0,4,7,11].forEach((n,i)=>setTimeout(()=>this.note(s[n%s.length]||440,0.04,0.5),i*80))},teleport(){for(let i=0;i<8;i++)setTimeout(()=>this.note(200+i*100,0.03,0.25),i*35)},emote(){this.note((SCALES[realm]||SCALES.genesis)[3],0.03,0.4)}};

const Voice={enabled:false,stream:null,ctx:null,analyser:null,speaking:false,ptt:false,async init(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});this.ctx=new(window.AudioContext||window.webkitAudioContext)();const src=this.ctx.createMediaStreamSource(this.stream);this.analyser=this.ctx.createAnalyser();this.analyser.fftSize=256;src.connect(this.analyser);this.stream.getAudioTracks().forEach(t=>t.enabled=!settings.ptt);this.enabled=true;stats.voiceUsed=1;checkAchs();this.startVAD();return true}catch(e){toast('üéôÔ∏è','Microphone Denied','','voice');return false}},startVAD(){if(!this.analyser)return;const data=new Uint8Array(this.analyser.frequencyBinCount);const check=()=>{if(!this.enabled)return;this.analyser.getByteFrequencyData(data);const avg=data.reduce((a,b)=>a+b)/data.length/255;const th=0.02*(1+(1-settings.sensitivity));const was=this.speaking;if(settings.ptt)this.speaking=this.ptt&&avg>th*0.5;else if(settings.vad)this.speaking=avg>th;if(this.speaking!==was)updateVoiceUI();updateVoiceViz(avg);requestAnimationFrame(check)};check()},setPTT(a){this.ptt=a;if(this.stream)this.stream.getAudioTracks().forEach(t=>t.enabled=a)},disable(){this.enabled=false;this.speaking=false;if(this.stream){this.stream.getTracks().forEach(t=>t.stop());this.stream=null}updateVoiceUI()}};
function updateVoiceUI(){const btn=$('voice-btn'),st=$('voice-status'),orb=$('my-orb');if(Voice.enabled){btn.classList.add('active');btn.classList.remove('muted');btn.textContent='üéôÔ∏è';st.textContent=Voice.speaking?'Talk':'On';orb.classList.toggle('speaking',Voice.speaking)}else{btn.classList.remove('active');btn.classList.add('muted');btn.textContent='üîá';st.textContent='Off';orb.classList.remove('speaking')}}
function updateVoiceViz(lvl){const bars=document.querySelectorAll('#voice-viz .vbar'),h=[3,5,8,5,3];if(Voice.enabled&&Voice.speaking)bars.forEach((b,i)=>{b.style.height=`${h[i]+Math.random()*lvl*15}px`;b.style.background='var(--green)'});else if(Voice.enabled)bars.forEach((b,i)=>{b.style.height=`${h[i]}px`;b.style.background='var(--blue)'});else bars.forEach((b,i)=>{b.style.height=`${h[i]}px`;b.style.background='var(--text-dim)'})}
async function toggleVoice(){if(Voice.enabled){Voice.disable();toast('üîá','Voice Disabled','','voice')}else{const ok=await Voice.init();if(ok)toast('üéôÔ∏è','Voice Enabled','Speak to be heard','voice')}}

const canvas=$('canvas'),ctx=canvas.getContext('2d'),mmCanvas=$('mm-canvas'),mmCtx=mmCanvas.getContext('2d');
let W,H;function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;mmCanvas.width=mmCanvas.offsetWidth*2;mmCanvas.height=mmCanvas.offsetHeight*2}addEventListener('resize',resize);resize();

const camera={x:0,y:0,tx:0,ty:0,shake:0};
const player={x:0,y:0,tx:0,ty:0,hue:settings.hue,xp:0,stars:0,echoes:0,singing:0,pulsing:0,emoting:null,emoteT:0,r:12,halo:60,trail:[],name:'Wanderer',id:'local-'+Math.random().toString(36).substr(2,9),born:Date.now(),bonds:new Map()};
const others=new Map(),projs=[],stars=new Map(),echoes=[],parts=[],floats=[],constells=[];
function $(id){return document.getElementById(id)}

class Star{constructor(x,y,lit=false,br=1,r='genesis'){this.x=x;this.y=y;this.lit=lit;this.burst=0;this.br=br;this.tw=Math.random()*Math.PI*2;this.tws=0.015+Math.random()*0.025;this.realm=r}}
class Echo{constructor(x,y,text,hue,name='Unknown',r='genesis'){this.x=x;this.y=y;this.text=text;this.hue=hue;this.name=name;this.r=10;this.pulse=0;this.realm=r}}
class Proj{constructor(x,y,vx,vy,text,owner,target=null){this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.text=text;this.owner=owner;this.target=target;this.life=C.WHISP_LIFE;this.hit=false;this.trail=[]}}
class Float{constructor(x,y,text,hue=0,size=14,dur=1.5){this.x=x;this.y=y;this.text=text;this.hue=hue;this.size=size;this.life=1;this.decay=1/(dur*60);this.vy=-0.8}}

function genStars(cx,cy,r){const k=`${r}:${cx},${cy}`;if(stars.has(k))return;const arr=[];let s=cx*12.9898+cy*78.233+r.charCodeAt(0)*0.1;const dm={void:0.5,nebula:1.3,abyss:0.3,crystal:1.5,celestial:1.8}[r]||1;const cnt=Math.floor((5+seed(s)*8)*dm);for(let i=0;i<cnt;i++){s=s*1.1+i*0.7;const lx=seed(s)*C.STAR_CELL;s=s*1.3+0.5;const ly=seed(s)*C.STAR_CELL;s=s*0.9+0.3;const br=0.25+seed(s)*0.75;arr.push(new Star(cx*C.STAR_CELL+lx,cy*C.STAR_CELL+ly,false,br,r))}stars.set(k,arr)}
function ensureStars(x,y,r){const cx=Math.floor(x/C.STAR_CELL),cy=Math.floor(y/C.STAR_CELL);for(let dx=-2;dx<=2;dx++)for(let dy=-2;dy<=2;dy++)genStars(cx+dx,cy+dy,r)}

function checkAch(id){if(unlocked.has(id))return;const a=ACHS.find(x=>x.id===id);if(!a)return;unlocked.add(id);Audio.ach();toast('üèÜ',a.name,a.desc,'achievement');gainXP(a.reward,false);saveAll();updateAchUI()}
function checkAchs(){ACHS.forEach(a=>{if(!unlocked.has(a.id)&&stats[a.track]>=a.need)checkAch(a.id)})}
function checkQuests(){D_QUESTS.forEach(q=>{const p=daily[q.track]||0;if(p>=q.need&&!daily[q.id+'_done']){daily[q.id+'_done']=true;Audio.quest();toast('‚úÖ',`Daily: ${q.name}`,`+${q.reward} XP`,'quest');gainXP(q.reward,false);saveAll()}});W_QUESTS.forEach(q=>{const p=weekly[q.track]||0;if(p>=q.need&&!weekly[q.id+'_done']){weekly[q.id+'_done']=true;Audio.quest();toast('‚úÖ',`Weekly: ${q.name}`,`+${q.reward} XP`,'quest');gainXP(q.reward,false);saveAll()}});updateQuestUI()}
function gainXP(amt,show=true){const old=getLvl(player.xp);player.xp+=amt;const nw=getLvl(player.xp);stats.level=nw;if(show)floats.push(new Float(player.x,player.y-player.halo-25,`+${amt} XP`,50,14));if(nw>old){Audio.levelUp();if(settings.particles)spawn(player.x,player.y,player.hue,60,true);player.r=12+nw*1.5;player.halo=60+nw*8;toast('‚ú®',`Level ${nw}!`,`You are now a ${getForm(nw)}`,'level');updateRealmLocks();checkAchs()}saveAll();updateHUD()}
function spawn(x,y,hue,cnt=20,exp=false){if(!settings.particles)return;const n=Math.min(cnt,C.MAX_PARTS-parts.length);for(let i=0;i<n;i++){const a=(i/cnt)*Math.PI*2+(exp?0:Math.random()),sp=exp?(2+Math.random()*5):(Math.random()*3);parts.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,size:Math.random()*5+2,hue:hue+(Math.random()-0.5)*40})}}

function createWhisper(text,target=null){let dx,dy;if(target&&others.has(target)){const t=others.get(target);dx=t.x-player.x;dy=t.y-player.y}else{dx=player.tx-player.x;dy=player.ty-player.y}const len=Math.hypot(dx,dy);if(len<10){dx=0;dy=-1}else{dx/=len;dy/=len}projs.push(new Proj(player.x+dx*40,player.y+dy*40,dx*C.WHISP_SPEED,dy*C.WHISP_SPEED,text,player.id,target));player.x-=dx*6;player.y-=dy*6;Audio.whisperSend();spawn(player.x+dx*40,player.y+dy*40,player.hue,12);stats.whispers++;daily.whispers=(daily.whispers||0)+1;weekly.whispers=(weekly.whispers||0)+1;checkAchs();checkQuests();saveAll()}
function doSing(){if(Date.now()<cds.sing)return;cds.sing=Date.now()+C.CD_SING;player.singing=1;Audio.sing();spawn(player.x,player.y,player.hue,35,true);if(settings.shake)camera.shake=0.35;stats.sings++;daily.sings=(daily.sings||0)+1;checkQuests();saveAll()}
function doPulse(){if(Date.now()<cds.pulse)return;cds.pulse=Date.now()+C.CD_PULSE;player.pulsing=1;Audio.pulse();spawn(player.x,player.y,player.hue,50,true);if(settings.shake)camera.shake=0.5;const vr=getViewR()*1.8;let lit=0;for(const[k,arr]of stars){if(!k.startsWith(realm+':'))continue;for(const s of arr){const d=Math.hypot(s.x-player.x,s.y-player.y);if(d<vr&&!s.lit){s.lit=true;s.burst=1;lit++}}}if(lit>0){player.stars+=lit;stats.stars+=lit;daily.stars=(daily.stars||0)+lit;weekly.stars=(weekly.stars||0)+lit;gainXP(lit*3);checkAchs();checkQuests()}stats.pulses++;saveAll()}
function createEcho(text){if(Date.now()<cds.echo)return;cds.echo=Date.now()+C.CD_ECHO;echoes.push(new Echo(player.x,player.y,text,player.hue,player.name,realm));player.echoes++;stats.echoes++;gainXP(25);Audio.echo();spawn(player.x,player.y,player.hue,40,true);checkAchs();saveAll()}
function doEmote(emoji){const lv=getLvl(player.xp),em=EMOTES.find(e=>e.e===emoji);if(em&&em.u>lv){toast('üîí','Locked',`Unlock at Level ${em.u}`);return}player.emoting=emoji;player.emoteT=3.5;spawn(player.x,player.y-player.halo,player.hue,15);Audio.emote();stats.emotes++;daily.emotes=(daily.emotes||0)+1;checkQuests();saveAll()}
function addFriend(id){if(friends.has(id))return false;friends.add(id);stats.friends=friends.size;weekly.newFriends=(weekly.newFriends||0)+1;Audio.friendAdd();checkAchs();checkQuests();saveAll();const o=others.get(id);toast('‚≠ê','Friend Added',o?.name||'Unknown','friend');return true}
function removeFriend(id){if(!friends.has(id))return false;friends.delete(id);stats.friends=friends.size;saveAll();const o=others.get(id);toast('üëã','Friend Removed',o?.name||'Unknown');return true}
function teleportTo(id){const o=others.get(id);if(!o||!friends.has(id))return;if(o.realm&&o.realm!==realm){changeRealm(o.realm);setTimeout(()=>{player.x=o.x+(Math.random()-0.5)*100;player.y=o.y+(Math.random()-0.5)*100;player.tx=player.x;player.ty=player.y;camera.x=player.x-W/2;camera.y=player.y-H/2},700)}else{player.x=o.x+(Math.random()-0.5)*100;player.y=o.y+(Math.random()-0.5)*100;player.tx=player.x;player.ty=player.y}Audio.teleport();spawn(player.x,player.y,player.hue,45,true);stats.teleports=(stats.teleports||0)+1;checkAchs();toast('üöÄ','Teleported',`To ${o.name}`)}
function changeRealm(id){if(id===realm)return;const r=REALMS[id];if(!r)return;if(getLvl(player.xp)<r.unlock){toast('üîí','Locked',`Unlock at Level ${r.unlock}`);return}$('trans-icon').textContent=r.icon;$('trans-name').textContent=r.name;$('trans-desc').textContent=r.desc;$('realm-trans').classList.add('active');Audio.realmTrans();setTimeout(()=>{realm=id;$('realm-name').textContent=r.name;$('realm-icon').textContent=r.icon;document.querySelectorAll('.realm').forEach(b=>b.classList.toggle('active',b.dataset.realm===id));player.x=0;player.y=0;player.tx=0;player.ty=0;camera.x=-W/2;camera.y=-H/2;Audio.setRealmTone(id);if(!visited.has(id)){visited.add(id);stats.realmsVisited=visited.size;weekly.realmChanges=(weekly.realmChanges||0)+1;checkAchs();checkQuests()}saveAll();setTimeout(()=>$('realm-trans').classList.remove('active'),800)},600)}
function updateRealmLocks(){const lv=getLvl(player.xp);document.querySelectorAll('.realm').forEach(b=>{const r=REALMS[b.dataset.realm];if(r)b.classList.toggle('locked',lv<r.unlock)})}
function checkSecretAchs(){const hr=new Date().getHours();if(hr>=0&&hr<5&&!stats.nightOwl){stats.nightOwl=1;checkAchs()}if(Date.now()-sessStart>2*60*60*1000&&!stats.marathon){stats.marathon=1;checkAchs()}}
function toast(icon,title,desc='',type=''){const c=$('toasts'),t=document.createElement('div');t.className='toast'+(type?' '+type:'');t.innerHTML=`<span class="toast-icon">${icon}</span><div class="toast-content"><div class="toast-title">${title}</div>${desc?`<div class="toast-desc">${desc}</div>`:''}</div>`;c.appendChild(t);setTimeout(()=>t.remove(),4500)}

function update(){if(!game)return;const ox=player.x,oy=player.y;player.x+=(player.tx-player.x)*C.DRIFT;player.y+=(player.ty-player.y)*C.DRIFT;if(Math.hypot(player.x-ox,player.y-oy)>0.5){player.trail.push({x:player.x,y:player.y,life:1});if(player.trail.length>40)player.trail.shift()}for(let i=player.trail.length-1;i>=0;i--){player.trail[i].life-=0.02;if(player.trail[i].life<=0)player.trail.splice(i,1)}camera.tx=player.x-W/2;camera.ty=player.y-H/2;const sx=settings.shake&&camera.shake>0?(Math.random()-0.5)*camera.shake*12:0;const sy=settings.shake&&camera.shake>0?(Math.random()-0.5)*camera.shake*12:0;camera.shake*=0.88;camera.x+=(camera.tx-camera.x)*C.CAM_EASE+sx;camera.y+=(camera.ty-camera.y)*C.CAM_EASE+sy;player.singing=Math.max(0,player.singing-0.016);player.pulsing=Math.max(0,player.pulsing-0.012);if(player.emoteT>0){player.emoteT-=0.016;if(player.emoteT<=0)player.emoting=null}ensureStars(player.x,player.y,realm);for(let i=projs.length-1;i>=0;i--){const p=projs[i];p.x+=p.vx;p.y+=p.vy;p.vx*=0.995;p.vy*=0.995;p.life--;p.trail.push({x:p.x,y:p.y});if(p.trail.length>20)p.trail.shift();if(p.target&&!p.hit&&others.has(p.target)){const t=others.get(p.target);const dx=t.x-p.x,dy=t.y-p.y,d=Math.hypot(dx,dy);if(d>30){p.vx+=(dx/d)*0.15;p.vy+=(dy/d)*0.15;const sp=Math.hypot(p.vx,p.vy);if(sp>C.WHISP_SPEED){p.vx=(p.vx/sp)*C.WHISP_SPEED;p.vy=(p.vy/sp)*C.WHISP_SPEED}}}if(!p.hit&&p.owner===player.id){others.forEach((o,id)=>{const d=Math.hypot(p.x-o.x,p.y-o.y);if(d<60){p.hit=true;p.vx*=0.03;p.vy*=0.03;const cur=player.bonds.get(id)||0;const nb=Math.min(100,cur+C.BOND_GAIN);player.bonds.set(id,nb);if(nb>stats.maxBond)stats.maxBond=nb;if(cur<25&&nb>=25){stats.connections++;daily.connections=(daily.connections||0)+1;toast('üí´','Connected',o.name,'friend');checkAchs();checkQuests()}spawn(o.x,o.y,o.hue,20);Audio.conn();gainXP(8);floats.push(new Float(o.x,o.y-o.halo-25,p.text,player.hue,16,2.5));recent.set(id,{...o,lastSeen:Date.now()})}})}if(p.life<=0)projs.splice(i,1)}player.bonds.forEach((s,id)=>{const ns=Math.max(0,s-C.BOND_DECAY);if(ns===0)player.bonds.delete(id);else player.bonds.set(id,ns)});others.forEach((o,id)=>{const b=player.bonds.get(id)||0;if(b>35&&!o.isBot){const dx=player.x-o.x,dy=player.y-o.y,d=Math.hypot(dx,dy);if(d>200&&d<C.TETHER){const f=(b/100)*0.2;o.x+=dx*f*0.01;o.y+=dy*f*0.01}}if(o.trail){for(let i=o.trail.length-1;i>=0;i--){o.trail[i].life-=0.025;if(o.trail[i].life<=0)o.trail.splice(i,1)}}if(o.singing>0)o.singing-=0.018;if(o.pulsing>0)o.pulsing-=0.012;if(o.emoteT>0){o.emoteT-=0.016;if(o.emoteT<=0)o.emoting=null}});for(const[k,arr]of stars){if(!k.startsWith(realm+':'))continue;for(const s of arr){if(s.burst>0)s.burst-=0.02;s.tw+=s.tws}}for(const e of echoes)if(e.realm===realm)e.pulse=Math.sin(Date.now()*0.002)*0.25;for(let i=parts.length-1;i>=0;i--){const p=parts[i];p.x+=p.vx;p.y+=p.vy;p.vx*=0.96;p.vy*=0.96;p.life-=0.015;if(p.life<=0)parts.splice(i,1)}for(let i=floats.length-1;i>=0;i--){const f=floats[i];f.y+=f.vy;f.life-=f.decay;if(f.life<=0)floats.splice(i,1)}constells.length=0;const conn=[player];others.forEach((o,id)=>{if((player.bonds.get(id)||0)>50)conn.push(o)});if(conn.length>=3){for(let i=0;i<conn.length;i++){for(let j=i+1;j<conn.length;j++){for(let k=j+1;k<conn.length;k++){const a=conn[i],b=conn[j],c=conn[k];const ab=Math.hypot(a.x-b.x,a.y-b.y);const bc=Math.hypot(b.x-c.x,b.y-c.y);const ca=Math.hypot(c.x-a.x,c.y-a.y);if(ab<300&&bc<300&&ca<300){constells.push([a,b,c]);if(!stats.constellation){stats.constellation=1;checkAchs()}}}}}}checkSecretAchs();updateHUD();updateSocialList()}

function render(){const r=REALMS[realm],bg=r.bg;ctx.fillStyle=`rgba(${bg[0]},${bg[1]},${bg[2]},0.12)`;ctx.fillRect(0,0,W,H);ctx.save();ctx.translate(-camera.x,-camera.y);const vr=getViewR();renderNebula(r);renderBgStars();renderStars(vr);renderEchoes(vr);renderConstells();renderTethers();renderOthers(vr);renderProjs();renderPlayer();renderParts();renderFloats();ctx.restore();renderVignette(r);renderMinimap();requestAnimationFrame(render)}
function renderNebula(r){const nx=player.x*0.015,ny=player.y*0.015,n1=r.n1,n2=r.n2;let g=ctx.createRadialGradient(W/2+camera.x+Math.sin(nx)*280,H/2+camera.y+Math.cos(ny)*280,0,W/2+camera.x,H/2+camera.y,750);g.addColorStop(0,`rgba(${n1[0]},${n1[1]},${n1[2]},0.028)`);g.addColorStop(1,`rgba(${n1[0]},${n1[1]},${n1[2]},0)`);ctx.fillStyle=g;ctx.fillRect(camera.x,camera.y,W,H);g=ctx.createRadialGradient(W/2+camera.x-Math.cos(nx*0.8)*380,H/2+camera.y-Math.sin(ny*0.8)*380,0,W/2+camera.x,H/2+camera.y,600);g.addColorStop(0,`rgba(${n2[0]},${n2[1]},${n2[2]},0.022)`);g.addColorStop(1,`rgba(${n2[0]},${n2[1]},${n2[2]},0)`);ctx.fillStyle=g;ctx.fillRect(camera.x,camera.y,W,H)}
function renderBgStars(){ctx.fillStyle='rgba(200,210,255,0.2)';for(let i=0;i<100;i++){const x=((i*73.1+camera.x*0.02)%W)+camera.x,y=((i*41.7+camera.y*0.02)%H)+camera.y,sz=((i*17)%3)*0.35+0.3;ctx.beginPath();ctx.arc(x,y,sz,0,Math.PI*2);ctx.fill()}}
function renderStars(vr){for(const[k,arr]of stars){if(!k.startsWith(realm+':'))continue;for(const s of arr){const dx=s.x-player.x,dy=s.y-player.y,d=Math.hypot(dx,dy);if(d>vr+200)continue;const a=Math.max(0,1-d/vr),tw=0.7+Math.sin(s.tw)*0.3;if(s.lit){const p=1+s.burst*0.8,rad=6*s.br*p;if(settings.glow){ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,rad*5);g.addColorStop(0,`rgba(232,197,71,${0.7*a*tw})`);g.addColorStop(0.4,`rgba(232,197,71,${0.25*a*tw})`);g.addColorStop(1,'rgba(232,197,71,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(s.x,s.y,rad*5,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation='source-over'}ctx.fillStyle=`rgba(255,255,255,${a*tw})`;ctx.beginPath();ctx.arc(s.x,s.y,rad*0.5,0,Math.PI*2);ctx.fill()}else{ctx.fillStyle=`rgba(150,160,180,${0.35*a*s.br*tw})`;ctx.beginPath();ctx.arc(s.x,s.y,2.5*s.br,0,Math.PI*2);ctx.fill()}}}}
function renderEchoes(vr){for(const e of echoes){if(e.realm!==realm)continue;const dx=e.x-player.x,dy=e.y-player.y,d=Math.hypot(dx,dy);if(d>vr+200)continue;const a=Math.max(0,1-d/vr),p=1+e.pulse*0.15,rad=e.r*p;if(settings.glow){ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,rad*6);g.addColorStop(0,`hsla(${e.hue},72%,58%,${0.6*a})`);g.addColorStop(0.4,`hsla(${e.hue},68%,48%,${0.2*a})`);g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(e.x,e.y,rad*6,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation='source-over'}ctx.fillStyle=`rgba(255,255,255,${a*0.9})`;ctx.beginPath();ctx.arc(e.x,e.y,rad,0,Math.PI*2);ctx.fill();if(d<100){ctx.fillStyle=`rgba(255,255,255,${a*0.85})`;ctx.font='14px Outfit';ctx.textAlign='center';ctx.fillText(e.text,e.x,e.y-rad-18);ctx.fillStyle=`rgba(255,255,255,${a*0.4})`;ctx.font='10px Outfit';ctx.fillText(`‚Äî ${e.name}`,e.x,e.y-rad-34)}}}
function renderConstells(){if(!constells.length)return;ctx.globalCompositeOperation='lighter';for(const[a,b,c]of constells){const cx=(a.x+b.x+c.x)/3,cy=(a.y+b.y+c.y)/3;const g=ctx.createRadialGradient(cx,cy,0,cx,cy,170);g.addColorStop(0,'rgba(232,197,71,0.06)');g.addColorStop(1,'rgba(232,197,71,0)');ctx.fillStyle=g;ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.lineTo(c.x,c.y);ctx.closePath();ctx.fill();ctx.strokeStyle='rgba(232,197,71,0.28)';ctx.lineWidth=1.5;ctx.stroke()}ctx.globalCompositeOperation='source-over'}
function renderTethers(){others.forEach((o,id)=>{const b=player.bonds.get(id)||0;if(b>18){const d=Math.hypot(player.x-o.x,player.y-o.y);if(d<C.TETHER){const a=(b/100)*(1-d/C.TETHER)*0.55;ctx.globalCompositeOperation='lighter';const isFriend=friends.has(id);const g=ctx.createLinearGradient(player.x,player.y,o.x,o.y);g.addColorStop(0,`hsla(${player.hue},72%,58%,${a})`);g.addColorStop(1,isFriend?`rgba(232,197,71,${a})`:`hsla(${o.hue},72%,58%,${a})`);ctx.strokeStyle=g;ctx.lineWidth=1.2+b/35;ctx.beginPath();ctx.moveTo(player.x,player.y);ctx.lineTo(o.x,o.y);ctx.stroke();ctx.globalCompositeOperation='source-over'}}})}
function renderOthers(vr){others.forEach((o,id)=>{if(!o||!isFinite(o.x)||!isFinite(o.y))return;const dx=o.x-player.x,dy=o.y-player.y,d=Math.hypot(dx,dy);if(d>vr+120)return;const a=Math.max(0.08,1-d/vr);const isFriend=friends.has(id);const halo=o.halo||60;if(o.trail&&o.trail.length>1){ctx.globalCompositeOperation='lighter';for(let i=1;i<o.trail.length;i++){const t=o.trail[i],p=o.trail[i-1];ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(t.x,t.y);ctx.strokeStyle=`hsla(${o.hue},68%,55%,${t.life*0.3*a})`;ctx.lineWidth=3.5*t.life;ctx.stroke()}ctx.globalCompositeOperation='source-over'}if(o.pulsing>0){ctx.beginPath();ctx.arc(o.x,o.y,(1-o.pulsing)*220,0,Math.PI*2);ctx.strokeStyle=`hsla(${o.hue},68%,55%,${o.pulsing*a*0.5})`;ctx.lineWidth=2;ctx.stroke()}if(o.singing>0){ctx.beginPath();ctx.arc(o.x,o.y,(1-o.singing)*180,0,Math.PI*2);ctx.strokeStyle=`hsla(${o.hue},62%,52%,${o.singing*a*0.45})`;ctx.lineWidth=2;ctx.stroke()}if(o.speaking){ctx.beginPath();const ph=(Date.now()%1000)/1000;ctx.arc(o.x,o.y,halo+15+Math.sin(ph*Math.PI*2)*5,0,Math.PI*2);ctx.strokeStyle=`rgba(34,197,94,${0.4*a})`;ctx.lineWidth=2;ctx.stroke()}if(isFriend){ctx.beginPath();ctx.arc(o.x,o.y,halo+8,0,Math.PI*2);ctx.strokeStyle=`rgba(232,197,71,${0.3*a})`;ctx.lineWidth=1.5;ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([])}if(settings.glow){ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,halo);g.addColorStop(0,`hsla(${o.hue},72%,58%,${0.48*a})`);g.addColorStop(0.45,`hsla(${o.hue},68%,48%,${0.18*a})`);g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(o.x,o.y,halo,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation='source-over'}ctx.fillStyle=`hsla(${o.hue},68%,72%,${a})`;ctx.beginPath();ctx.arc(o.x,o.y,o.r||12,0,Math.PI*2);ctx.fill();if(o.emoting&&o.emoteT>0){ctx.font='26px sans-serif';ctx.textAlign='center';ctx.fillText(o.emoting,o.x,o.y-halo-14)}ctx.fillStyle=`rgba(255,255,255,${a*0.68})`;ctx.font='11px Outfit';ctx.textAlign='center';ctx.fillText((isFriend?'‚≠ê ':'')+o.name,o.x,o.y-(o.r||12)-12)})}
function renderProjs(){for(const p of projs){const a=Math.min(1,p.life/70);if(p.trail.length>1){ctx.globalCompositeOperation='lighter';ctx.beginPath();ctx.moveTo(p.trail[0].x,p.trail[0].y);for(let i=1;i<p.trail.length;i++)ctx.lineTo(p.trail[i].x,p.trail[i].y);ctx.strokeStyle=`rgba(180,200,255,${a*0.22})`;ctx.lineWidth=2.5;ctx.stroke();ctx.globalCompositeOperation='source-over'}if(settings.glow){ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,35);g.addColorStop(0,`rgba(200,220,255,${a*0.35})`);g.addColorStop(1,'rgba(200,220,255,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(p.x,p.y,35,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation='source-over'}ctx.fillStyle=`rgba(255,255,255,${a*0.9})`;ctx.font='13px Outfit';ctx.textAlign='center';ctx.fillText(p.text,p.x,p.y+5)}}
function renderPlayer(){if(player.trail.length>1){ctx.globalCompositeOperation='lighter';for(let i=1;i<player.trail.length;i++){const t=player.trail[i],p=player.trail[i-1];ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(t.x,t.y);ctx.strokeStyle=`hsla(${player.hue},68%,55%,${t.life*0.38})`;ctx.lineWidth=4*t.life;ctx.stroke()}ctx.globalCompositeOperation='source-over'}if(player.pulsing>0){ctx.beginPath();ctx.arc(player.x,player.y,(1-player.pulsing)*220,0,Math.PI*2);ctx.strokeStyle=`hsla(${player.hue},68%,55%,${player.pulsing*0.5})`;ctx.lineWidth=2;ctx.stroke()}if(player.singing>0){ctx.beginPath();ctx.arc(player.x,player.y,(1-player.singing)*180,0,Math.PI*2);ctx.strokeStyle=`hsla(${player.hue},62%,52%,${player.singing*0.45})`;ctx.lineWidth=2;ctx.stroke()}if(settings.glow){ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(player.x,player.y,0,player.x,player.y,player.halo);g.addColorStop(0,`hsla(${player.hue},72%,58%,0.55)`);g.addColorStop(0.45,`hsla(${player.hue},68%,48%,0.2)`);g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(player.x,player.y,player.halo,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation='source-over'}ctx.fillStyle=`hsl(${player.hue},68%,75%)`;ctx.beginPath();ctx.arc(player.x,player.y,player.r,0,Math.PI*2);ctx.fill();if(player.emoting&&player.emoteT>0){ctx.font='28px sans-serif';ctx.textAlign='center';ctx.fillText(player.emoting,player.x,player.y-player.halo-14)}}
function renderParts(){ctx.globalCompositeOperation='lighter';for(const p of parts){ctx.fillStyle=`hsla(${p.hue},70%,58%,${p.life*0.65})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill()}ctx.globalCompositeOperation='source-over'}
function renderFloats(){for(const f of floats){ctx.fillStyle=`hsla(${f.hue},70%,65%,${f.life})`;ctx.font=`600 ${f.size}px Outfit`;ctx.textAlign='center';ctx.fillText(f.text,f.x,f.y)}}
function renderVignette(r){const g=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*0.7);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,`rgba(${r.bg[0]},${r.bg[1]},${r.bg[2]},0.5)`);ctx.fillStyle=g;ctx.fillRect(0,0,W,H)}
function renderMinimap(){const sc=C.MM_R*2/mmCanvas.width;mmCtx.fillStyle='rgba(5,5,15,0.4)';mmCtx.fillRect(0,0,mmCanvas.width,mmCanvas.height);const cx=mmCanvas.width/2,cy=mmCanvas.height/2;for(const[k,arr]of stars){if(!k.startsWith(realm+':'))continue;for(const s of arr){if(!s.lit)continue;const dx=(s.x-player.x)/sc,dy=(s.y-player.y)/sc;if(Math.hypot(dx,dy)>cx)continue;mmCtx.fillStyle='rgba(232,197,71,0.6)';mmCtx.beginPath();mmCtx.arc(cx+dx,cy+dy,1.5,0,Math.PI*2);mmCtx.fill()}}others.forEach((o,id)=>{const dx=(o.x-player.x)/sc,dy=(o.y-player.y)/sc;if(Math.hypot(dx,dy)>cx)return;const isFriend=friends.has(id);mmCtx.fillStyle=isFriend?'rgba(232,197,71,0.9)':`hsla(${o.hue},70%,60%,0.7)`;mmCtx.beginPath();mmCtx.arc(cx+dx,cy+dy,isFriend?3:2,0,Math.PI*2);mmCtx.fill()});mmCtx.fillStyle='rgba(255,255,255,0.95)';mmCtx.beginPath();mmCtx.arc(cx,cy,3.5,0,Math.PI*2);mmCtx.fill();$('mm-coords').textContent=`${Math.round(player.x)}, ${Math.round(player.y)}`}

function updateHUD(){const lv=getLvl(player.xp),form=getForm(lv);$('my-name').textContent=player.name;$('my-title').textContent=form;$('lvl-badge').textContent=lv;const prev=C.LVL_XP[lv-1]||0,next=C.LVL_XP[lv]||player.xp+1000;const prog=((player.xp-prev)/(next-prev))*100;$('xp-val').textContent=`${player.xp} / ${next}`;$('xp-fill').style.width=`${Math.min(100,prog)}%`;$('conn-val').textContent=[...player.bonds.values()].filter(b=>b>25).length;$('friend-val').textContent=friends.size;$('stars-val').textContent=player.stars;$('friends-badge').textContent=friends.size;const orb=$('my-orb');orb.style.background=`linear-gradient(135deg,hsl(${player.hue},70%,58%),hsl(${player.hue+35},60%,48%))`;orb.style.boxShadow=`0 0 18px hsla(${player.hue},70%,50%,0.55)`}
function updateSocialList(){if(!panels.social)return;const list=$('social-list');let arr=[];if(socTab==='nearby'){others.forEach((o,id)=>{const d=Math.hypot(o.x-player.x,o.y-player.y);if(d<C.TETHER*2.5)arr.push({...o,id,dist:d,bond:player.bonds.get(id)||0,isFriend:friends.has(id),online:true})});arr.sort((a,b)=>(b.isFriend?1000:0)+b.bond-(a.isFriend?1000:0)-a.bond)}else if(socTab==='friends'){friends.forEach(id=>{const o=others.get(id);if(o){const d=Math.hypot(o.x-player.x,o.y-player.y);arr.push({...o,id,dist:d,bond:player.bonds.get(id)||0,isFriend:true,online:true})}else if(recent.has(id)){const rp=recent.get(id);arr.push({...rp,id,dist:Infinity,bond:0,isFriend:true,online:false})}});arr.sort((a,b)=>(b.online?1:0)-(a.online?1:0))}else if(socTab==='recent'){recent.forEach((rp,id)=>{if(!friends.has(id)){const o=others.get(id);arr.push({...rp,...(o||{}),id,dist:o?Math.hypot(o.x-player.x,o.y-player.y):Infinity,bond:player.bonds.get(id)||0,isFriend:false,online:!!o})}});arr.sort((a,b)=>(b.lastSeen||0)-(a.lastSeen||0));arr=arr.slice(0,15)}if(!arr.length){const msgs={nearby:'No souls nearby...',friends:'No friends yet',recent:'No recent interactions'};list.innerHTML=`<div class="empty-state"><div class="empty-icon">üåå</div><div class="empty-text">${msgs[socTab]}</div></div>`;return}list.innerHTML=arr.slice(0,15).map(p=>`<div class="player-card${p.speaking?' speaking':''}${p.isFriend?' friend':''}${!p.online?' offline':''}" data-id="${p.id}"><div class="player-orb" style="background:linear-gradient(135deg,hsl(${p.hue},70%,55%),hsl(${p.hue+30},60%,45%));box-shadow:0 0 10px hsla(${p.hue},70%,50%,0.5)"><div class="indicator ${p.online?'online':'offline'}"></div><div class="speak-ring"></div></div><div class="player-info"><div class="player-name">${p.isFriend?'‚≠ê ':''}${p.name}</div><div class="player-status${p.speaking?' speaking':p.bond>25?' connected':''}">${!p.online?'Offline':p.speaking?'Speaking':p.bond>25?'Connected':Math.round(p.dist)+'m'}</div></div><div class="player-bond"><div class="player-bond-fill" style="width:${p.bond}%"></div></div></div>`).join('');list.querySelectorAll('.player-card').forEach(el=>el.addEventListener('click',()=>showProfile(el.dataset.id)))}
function updateAchUI(){const grid=$('ach-grid');const filtered=ACHS.filter(a=>achTab==='all'||a.cat===achTab);grid.innerHTML=filtered.map(a=>{const done=unlocked.has(a.id);const prog=Math.min(100,(stats[a.track]||0)/a.need*100);const isSecret=a.secret&&!done;return`<div class="ach-card ${done?'unlocked':'locked'}${a.secret?' secret':''}"><div class="ach-icon">${isSecret?'‚ùì':a.icon}</div><div class="ach-details"><div class="ach-name">${isSecret?'???':a.name}</div><div class="ach-desc">${isSecret?'Secret achievement':a.desc}</div><div class="ach-reward">+${a.reward} XP</div>${!done&&!isSecret?`<div class="ach-bar"><div class="ach-bar-fill" style="width:${prog}%"></div></div>`:''}</div></div>`}).join('');$('ach-count').textContent=unlocked.size;$('ach-total').textContent=ACHS.length}
function updateQuestUI(){const list=$('quests-list');const dHTML=D_QUESTS.map(q=>{const p=daily[q.track]||0;const done=daily[q.id+'_done'];const pct=Math.min(100,p/q.need*100);return`<div class="quest-card${done?' complete':''}"><div class="quest-header"><div class="quest-name">${q.icon} ${q.name}</div><div class="quest-reward">+${q.reward} ‚ö°</div></div><div class="quest-desc">${q.desc}</div><div class="quest-progress"><div class="quest-bar"><div class="quest-bar-fill" style="width:${pct}%"></div></div><div class="quest-count">${Math.min(p,q.need)}/${q.need}</div></div></div>`}).join('');const wHTML=W_QUESTS.map(q=>{const p=weekly[q.track]||0;const done=weekly[q.id+'_done'];const pct=Math.min(100,p/q.need*100);return`<div class="quest-card weekly${done?' complete':''}"><div class="quest-header"><div class="quest-name">${q.icon} ${q.name}</div><div class="quest-reward">+${q.reward} ‚ö°</div></div><div class="quest-desc">${q.desc}</div><div class="quest-progress"><div class="quest-bar"><div class="quest-bar-fill" style="width:${pct}%"></div></div><div class="quest-count">${Math.min(p,q.need)}/${q.need}</div></div></div>`}).join('');list.innerHTML=`<div class="quest-section"><div class="quest-section-title"><span>‚òÄÔ∏è</span> Daily</div>${dHTML}</div><div class="quest-section"><div class="quest-section-title"><span>üìÖ</span> Weekly</div>${wHTML}</div>`;$('quest-timer').textContent=formatTime(getResetTime())}
function showProfile(id){const o=others.get(id);if(!o)return;selId=id;const panel=$('profile');const bond=player.bonds.get(id)||0;const isFriend=friends.has(id);$('prof-banner').style.background=`linear-gradient(135deg,hsl(${o.hue},70%,40%),hsl(${o.hue+40},60%,30%))`;$('prof-avatar').style.background=`linear-gradient(135deg,hsl(${o.hue},70%,55%),hsl(${o.hue+30},60%,45%))`;$('prof-friend-badge').style.display=isFriend?'flex':'none';$('prof-name').textContent=o.name;$('prof-title').textContent=`${getForm(o.level||1)} ‚Ä¢ Lv ${o.level||1}`;$('prof-status').innerHTML=o.speaking?'<span>‚óè</span> Speaking':'<span>‚óè</span> Online';$('prof-status').className='prof-status '+(o.speaking?'speaking':'online');$('prof-stars').textContent=o.stars||0;$('prof-echoes').textContent=o.echoes||0;const age=Math.floor((Date.now()-(o.born||Date.now()))/3600000);$('prof-age').textContent=age+'h';$('prof-bond-val').textContent=Math.round(bond)+'%';$('prof-bond-fill').style.width=bond+'%';$('prof-friend').textContent=isFriend?'‚úï Remove':'‚≠ê Add Friend';$('prof-friend').className=isFriend?'prof-btn danger':'prof-btn';$('prof-teleport').style.display=isFriend?'flex':'none';const rect=document.body.getBoundingClientRect();let px=Math.min(W-290,(o.x-camera.x)+50);let py=Math.min(H-380,(o.y-camera.y)+50);px=Math.max(10,px);py=Math.max(10,py);panel.style.left=px+'px';panel.style.top=py+'px';panel.classList.add('show');panels.profile=true}
function hideProfile(){$('profile').classList.remove('show');selId=null;panels.profile=false}

function buildRealms(){const cont=$('realms');cont.innerHTML='';const lv=getLvl(player.xp);Object.entries(REALMS).forEach(([id,r])=>{const locked=lv<r.unlock;const div=document.createElement('div');div.className='realm'+(id===realm?' active':'')+(locked?' locked':'');div.dataset.realm=id;div.innerHTML=`${r.icon}<div class="realm-tip"><div class="realm-tip-name">${r.name}</div><div class="realm-tip-desc">${r.desc}</div>${locked?`<div class="realm-tip-lock">üîí Level ${r.unlock}</div>`:''}</div>`;if(!locked)div.addEventListener('click',()=>changeRealm(id));cont.appendChild(div)})}
function buildEmotes(){const el=$('emotes');el.innerHTML='<div id="emote-center">Pick an<br>emote</div>';const lv=getLvl(player.xp),cnt=EMOTES.length;EMOTES.forEach((em,i)=>{const a=(i/cnt)*Math.PI*2-Math.PI/2;const r=85;const x=120+Math.cos(a)*r-19;const y=120+Math.sin(a)*r-19;const locked=em.u>lv;const btn=document.createElement('div');btn.className='emote'+(locked?' locked':'');btn.style.left=x+'px';btn.style.top=y+'px';btn.innerHTML=em.e+(locked?`<div class="lock">üîí</div>`:'');if(!locked)btn.addEventListener('click',()=>{doEmote(em.e);el.classList.remove('show');el.style.display='none';panels.emotes=false});el.appendChild(btn)})}
function buildColors(){const picker=$('color-picker');const hues=[0,30,60,120,180,210,270,320];picker.innerHTML=hues.map(h=>`<div class="color-opt${Math.abs(h-settings.hue)<20||Math.abs(h-settings.hue)>340?' selected':''}" data-hue="${h}" style="background:linear-gradient(135deg,hsl(${h},70%,55%),hsl(${h+30},60%,45%));box-shadow:0 0 8px hsla(${h},70%,50%,0.5)"></div>`).join('');picker.querySelectorAll('.color-opt').forEach(opt=>{opt.addEventListener('click',()=>{const h=parseInt(opt.dataset.hue);settings.hue=h;player.hue=h;picker.querySelectorAll('.color-opt').forEach(o=>o.classList.remove('selected'));opt.classList.add('selected');saveAll();updateHUD()})})}
function applySettings(){document.querySelectorAll('.toggle').forEach(t=>{const s=t.dataset.setting;if(settings[s]!==undefined)t.classList.toggle('on',settings[s])});const vol=document.querySelector('[data-setting="volume"]');if(vol){vol.querySelector('.slider-fill').style.width=`${settings.volume*100}%`;vol.parentElement.querySelector('.slider-val').textContent=`${Math.round(settings.volume*100)}%`}}

function setupInput(){const handleMove=(x,y)=>{player.tx=x+camera.x;player.ty=y+camera.y};canvas.addEventListener('mousemove',e=>{handleMove(e.clientX,e.clientY);$('cursor').style.transform=`translate(${e.clientX-15}px,${e.clientY-15}px)`});canvas.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];handleMove(t.clientX,t.clientY)},{passive:false});canvas.addEventListener('touchmove',e=>{e.preventDefault();const t=e.touches[0];handleMove(t.clientX,t.clientY)},{passive:false});canvas.addEventListener('click',e=>{const cx=e.clientX+camera.x,cy=e.clientY+camera.y;others.forEach((o,id)=>{const d=Math.hypot(o.x-cx,o.y-cy);if(d<60)showProfile(id)})});document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT')return;const k=e.key.toLowerCase();if(k==='w')toggleMsg('whisper');else if(k==='s')doSing();else if(k==='p')doPulse();else if(k==='e')toggleMsg('echo');else if(k==='q'){const el=$('emotes');if(panels.emotes){el.classList.remove('show');el.style.display='none';panels.emotes=false}else{el.style.left=(W/2-120)+'px';el.style.top=(H/2-120)+'px';el.style.display='block';el.classList.add('show');panels.emotes=true}}else if(k==='v')toggleVoice();else if(k==='tab'){e.preventDefault();togglePanel('social')}else if(k==='escape'){hideProfile();hideAllPanels();hideMsgBox();$('emotes').classList.remove('show');$('emotes').style.display='none';panels.emotes=false}else if(k==='f'&&selId){if(friends.has(selId))removeFriend(selId);else addFriend(selId);showProfile(selId)}else if(k===' '&&settings.ptt){e.preventDefault();Voice.setPTT(true)}});document.addEventListener('keyup',e=>{if(e.key===' '&&settings.ptt)Voice.setPTT(false)});const msgInput=$('msg-input');msgInput.addEventListener('keydown',e=>{if(e.key==='Enter'){const text=msgInput.value.trim();if(text){if(msgMode==='whisper')createWhisper(text,directTgt);else if(msgMode==='echo')createEcho(text);hideMsgBox()}}else if(e.key==='Escape')hideMsgBox()});$('btn-social').addEventListener('click',()=>togglePanel('social'));$('btn-whisper').addEventListener('click',()=>toggleMsg('whisper'));$('btn-sing').addEventListener('click',()=>doSing());$('btn-pulse').addEventListener('click',()=>doPulse());$('btn-echo').addEventListener('click',()=>toggleMsg('echo'));$('btn-emote').addEventListener('click',()=>{const el=$('emotes');if(panels.emotes){el.classList.remove('show');el.style.display='none';panels.emotes=false}else{el.style.left=(W/2-120)+'px';el.style.top=(H/2-120)+'px';el.style.display='block';el.classList.add('show');panels.emotes=true}});$('btn-quests').addEventListener('click',()=>togglePanel('quests'));$('btn-ach').addEventListener('click',()=>togglePanel('achievements'));$('btn-settings').addEventListener('click',()=>togglePanel('settings'));$('voice-btn').addEventListener('click',toggleVoice);document.querySelectorAll('.panel-close').forEach(btn=>{btn.addEventListener('click',()=>{const p=btn.dataset.panel;$(p).classList.remove('show');panels[p.replace('-panel','').replace('ach','achievements')]=false})});document.querySelectorAll('.panel-tab').forEach(tab=>{tab.addEventListener('click',()=>{document.querySelectorAll('.panel-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');if(tab.dataset.tab){socTab=tab.dataset.tab;updateSocialList()}if(tab.dataset.achtab){achTab=tab.dataset.achtab;updateAchUI()}})});document.querySelectorAll('.toggle').forEach(t=>{t.addEventListener('click',()=>{const s=t.dataset.setting;settings[s]=!settings[s];t.classList.toggle('on',settings[s]);if(s==='music'){if(settings.music)Audio.startDrone();else Audio.stopDrone()}saveAll()})});document.querySelectorAll('.slider').forEach(sl=>{sl.addEventListener('click',e=>{const rect=sl.getBoundingClientRect();const pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));sl.querySelector('.slider-fill').style.width=`${pct*100}%`;sl.parentElement.querySelector('.slider-val').textContent=`${Math.round(pct*100)}%`;const setting=sl.dataset.setting;if(setting==='volume')Audio.setVol(pct);else if(setting==='sensitivity')settings.sensitivity=pct;saveAll()})});$('prof-whisper').addEventListener('click',()=>{if(!selId)return;directTgt=selId;toggleMsg('whisper');hideProfile()});$('prof-follow').addEventListener('click',()=>{if(!selId)return;const o=others.get(selId);if(o){player.tx=o.x;player.ty=o.y}hideProfile()});$('prof-friend').addEventListener('click',()=>{if(!selId)return;if(friends.has(selId))removeFriend(selId);else addFriend(selId);showProfile(selId)});$('prof-teleport').addEventListener('click',()=>{if(!selId)return;teleportTo(selId);hideProfile()});$('identity').addEventListener('click',()=>togglePanel('settings'));document.addEventListener('click',e=>{if(!e.target.closest('#profile')&&!e.target.closest('.player-card'))hideProfile();if(!e.target.closest('#emotes')&&!e.target.closest('#btn-emote')){$('emotes').classList.remove('show');$('emotes').style.display='none';panels.emotes=false}})}
function togglePanel(id){const panel=$(id);const showing=panel.classList.contains('show');hideAllPanels();if(!showing){panel.classList.add('show');panels[id]=true;if(id==='social')updateSocialList();if(id==='achievements')updateAchUI();if(id==='settings')applySettings();if(id==='quests')updateQuestUI()}}
function hideAllPanels(){['social','achievements','settings','quests'].forEach(id=>{$(id).classList.remove('show');panels[id]=false})}
function toggleMsg(mode){if(msgMode===mode){hideMsgBox();return}msgMode=mode;const box=$('msg-box'),input=$('msg-input'),target=$('msg-target');box.classList.add('show');input.placeholder=mode==='whisper'?'Whisper into the void...':'Leave an echo...';input.value='';input.focus();if(mode==='whisper'&&directTgt&&others.has(directTgt)){target.textContent=`‚Üí ${others.get(directTgt).name}`;target.classList.add('show')}else{target.classList.remove('show');directTgt=null}}
function hideMsgBox(){$('msg-box').classList.remove('show');$('msg-target').classList.remove('show');msgMode=null;directTgt=null}

function spawnBots(cnt=8){const names=['Luna','Sol','Nova','Aria','Echo','Vega','Orion','Celeste','Zephyr','Aurora','Lyra','Atlas','Phoenix','Stella','Cosmos','Nebula'];for(let i=0;i<cnt;i++){const id='bot-'+i;const angle=Math.random()*Math.PI*2;const dist=150+Math.random()*450;others.set(id,{x:Math.cos(angle)*dist,y:Math.sin(angle)*dist,hue:Math.random()*360,name:names[i%names.length],r:12,halo:60,trail:[],singing:0,pulsing:0,emoting:null,emoteT:0,speaking:false,isBot:true,stars:Math.floor(Math.random()*60),echoes:Math.floor(Math.random()*15),level:1+Math.floor(Math.random()*10),born:Date.now()-Math.random()*86400000})}}
function animateBots(){others.forEach((o,id)=>{if(!o.isBot)return;o.x+=Math.sin(Date.now()*0.0003+id.charCodeAt(4)*0.5)*0.45;o.y+=Math.cos(Date.now()*0.00025+id.charCodeAt(5)*0.5)*0.45;if(!o.trail)o.trail=[];o.trail.push({x:o.x,y:o.y,life:1});if(o.trail.length>22)o.trail.shift();if(Math.random()<0.0006){o.emoting=EMOTES[Math.floor(Math.random()*8)].e;o.emoteT=3}if(Math.random()<0.0004)o.singing=1;if(Math.random()<0.0003)o.speaking=!o.speaking})}

function init(){loadAll();buildRealms();buildEmotes();buildColors();updateRealmLocks();updateAchUI();updateQuestUI();setInterval(()=>$('quest-timer').textContent=formatTime(getResetTime()),1000);$('start-btn').addEventListener('click',startGame);$('name-input').addEventListener('keydown',e=>{if(e.key==='Enter')startGame()});$('ob-go').addEventListener('click',()=>{$('onboard').classList.remove('show');game=true;Audio.init();Audio.startDrone()});setupInput();render()}
function startGame(){const name=$('name-input').value.trim()||'Wanderer';player.name=name;$('loading').classList.add('hide');setTimeout(()=>{$('onboard').classList.add('show');spawnBots(10)},1200);setInterval(()=>{update();animateBots()},1000/60)}
init();
</script>
</body></html>